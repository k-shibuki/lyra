============================= test session starts ==============================
platform linux -- Python 3.12.3, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/statuser/lancet
configfile: pyproject.toml
plugins: asyncio-1.3.0, anyio-4.12.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 2798 items / 23 deselected / 2775 selected

tests/test_ab_test.py ......................................             [  1%]
tests/test_bfs.py ...............................                        [  2%]
tests/test_browser_archive.py .....................................      [  3%]
tests/test_browser_provider.py ......................................... [  5%]
...                                                                      [  5%]
tests/test_browser_search_provider.py .............................      [  6%]
tests/test_budget.py ..........................................          [  7%]
tests/test_calibrate_rollback.py .............                           [  8%]
tests/test_calibration.py .............................................. [ 10%]
......................                                                   [ 10%]
tests/test_chain_of_density.py ..............................            [ 11%]
tests/test_circuit_breaker.py .............................              [ 13%]
tests/test_claim_decomposition.py ....................................   [ 14%]
tests/test_claim_timeline.py ........................................... [ 15%]
....                                                                     [ 16%]
tests/test_crt_transparency.py ......................                    [ 16%]
tests/test_deduplication.py .......................                      [ 17%]
tests/test_dns_policy.py .....................................           [ 18%]
tests/test_domain_policy.py ............................................ [ 20%]
............................................                             [ 22%]
tests/test_engine_config.py ............................................ [ 23%]
.....                                                                    [ 23%]
tests/test_entity_integration.py ...................                     [ 24%]
tests/test_entity_kb.py ................................................ [ 26%]
....                                                                     [ 26%]
tests/test_evidence_graph.py .........................................   [ 27%]
tests/test_extractor.py ........FFFFFF.FFF..                             [ 28%]
tests/test_fetcher.py .................................................. [ 30%]
.......                                                                  [ 30%]
tests/test_filter.py .....................                               [ 31%]
tests/test_http3_policy.py ............................................. [ 33%]
                                                                         [ 33%]
tests/test_human_behavior.py ........................................... [ 34%]
.                                                                        [ 34%]
tests/test_integration.py ........................                       [ 35%]
tests/test_intervention_queue.py ....................................... [ 36%]
......                                                                   [ 37%]
tests/test_ipv6_manager.py ............................................. [ 38%]
...................                                                      [ 39%]
tests/test_lifecycle.py .............................                    [ 40%]
tests/test_llm_provider.py ............................................. [ 42%]
.................                                                        [ 42%]
tests/test_llm_security.py ............................................. [ 44%]
.............................                                            [ 45%]
tests/test_mcp_auth.py ............................                      [ 46%]
tests/test_mcp_calibrate.py ..........................                   [ 47%]
tests/test_mcp_errors.py .........................                       [ 48%]
tests/test_mcp_get_status.py ...............                             [ 48%]
tests/test_mcp_notification.py .....................                     [ 49%]
tests/test_mcp_search.py ...............................                 [ 50%]
tests/test_metrics.py ..........................                         [ 51%]
tests/test_ml_server.py ..............FF..FF....FFFFssss                 [ 52%]
tests/test_notification.py ........................................      [ 54%]
tests/test_notification_provider.py .................................... [ 55%]
......................................                                   [ 56%]
tests/test_page_classifier.py .......................................    [ 58%]
tests/test_parser_diagnostics.py ....................................... [ 59%]
...........................                                              [ 60%]
tests/test_pivot.py .................................                    [ 61%]
tests/test_policy_engine.py ..................                           [ 62%]
tests/test_profile_audit.py ..............................               [ 63%]
tests/test_quality_analyzer.py ........................................  [ 65%]
tests/test_rdap_whois.py ......................                          [ 65%]
tests/test_replay.py ....................                                [ 66%]
tests/test_report.py .........................................           [ 68%]
tests/test_research.py ................................                  [ 69%]
tests/test_response_meta.py ..............................               [ 70%]
tests/test_response_sanitizer.py ...............................         [ 71%]
tests/test_robots.py ........................................            [ 72%]
tests/test_search.py ................................................... [ 74%]
..........................                                               [ 75%]
tests/test_search_parsers.py ........................................... [ 77%]
......................                                                   [ 77%]
tests/test_search_provider.py .............................              [ 78%]
tests/test_sec_fetch.py ................................................ [ 80%]
.................                                                        [ 81%]
tests/test_secure_logging.py ...........................                 [ 82%]
tests/test_session_transfer.py ...................................       [ 83%]
tests/test_site_search.py ..............................                 [ 84%]
tests/test_source_verification.py ...................................... [ 85%]
.............                                                            [ 86%]
tests/test_stealth.py ..........................                         [ 87%]
tests/test_storage.py ..........................                         [ 88%]
tests/test_temporal_consistency.py ..................................... [ 89%]
........                                                                 [ 89%]
tests/test_ucb_allocator.py ............................................ [ 91%]
.                                                                        [ 91%]
tests/test_undetected.py ...........................                     [ 92%]
tests/test_utils.py .............................                        [ 93%]
tests/test_utils_api_retry.py ...................................        [ 94%]
tests/test_utils_backoff.py ..........................................   [ 96%]
tests/test_utils_circuit_breaker.py ................................     [ 97%]
tests/test_wayback.py .................................                  [ 98%]
tests/test_wayback_fallback.py ....................................      [100%]

=================================== FAILURES ===================================
_________________ TestPDFExtraction.test_pdf_extraction_basic __________________
tests/test_extractor.py:201: in test_pdf_extraction_basic
    with patch("fitz.open") as mock_fitz:
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'fitz'
_______ TestPDFExtraction.test_pdf_extraction_triggers_ocr_for_low_text ________
tests/test_extractor.py:229: in test_pdf_extraction_triggers_ocr_for_low_text
    with patch("fitz.open") as mock_fitz:
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'fitz'
_______________ TestPDFExtraction.test_pdf_extraction_force_ocr ________________
tests/test_extractor.py:261: in test_pdf_extraction_force_ocr
    with patch("fitz.open") as mock_fitz:
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'fitz'
___________________ TestOCREngines.test_paddleocr_extraction ___________________
tests/test_extractor.py:297: in test_paddleocr_extraction
    from PIL import Image
E   ModuleNotFoundError: No module named 'PIL'
____________ TestOCREngines.test_tesseract_extraction_via_ocr_image ____________
tests/test_extractor.py:331: in test_tesseract_extraction_via_ocr_image
    from PIL import Image
E   ModuleNotFoundError: No module named 'PIL'
_____________ TestOCREngines.test_paddleocr_filters_low_confidence _____________
tests/test_extractor.py:357: in test_paddleocr_filters_low_confidence
    from PIL import Image
E   ModuleNotFoundError: No module named 'PIL'
____________________ TestOCRImage.test_ocr_image_from_data _____________________
tests/test_extractor.py:405: in test_ocr_image_from_data
    from PIL import Image
E   ModuleNotFoundError: No module named 'PIL'
_____________ TestOCRImage.test_ocr_image_falls_back_to_tesseract ______________
tests/test_extractor.py:428: in test_ocr_image_falls_back_to_tesseract
    from PIL import Image
E   ModuleNotFoundError: No module named 'PIL'
_______________ TestOCRImage.test_ocr_image_no_engine_available ________________
tests/test_extractor.py:452: in test_ocr_image_no_engine_available
    from PIL import Image
E   ModuleNotFoundError: No module named 'PIL'
_______________ TestEmbeddingService.test_encode_with_mock_model _______________
tests/test_ml_server.py:418: in test_encode_with_mock_model
    with patch(
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'sentence_transformers'
_____________ TestEmbeddingService.test_encode_model_load_failure ______________
tests/test_ml_server.py:451: in test_encode_model_load_failure
    with patch(
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'sentence_transformers'
_______________ TestRerankerService.test_rerank_with_mock_model ________________
tests/test_ml_server.py:528: in test_rerank_with_mock_model
    with patch("sentence_transformers.CrossEncoder", return_value=mock_model):
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'sentence_transformers'
______________ TestRerankerService.test_rerank_model_load_failure ______________
tests/test_ml_server.py:560: in test_rerank_model_load_failure
    with patch(
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'sentence_transformers'
_________________ TestNLIService.test_predict_with_mock_model __________________
tests/test_ml_server.py:664: in test_predict_with_mock_model
    with patch("transformers.pipeline", return_value=mock_pipeline):
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'transformers'
______________ TestNLIService.test_predict_batch_with_mock_model _______________
tests/test_ml_server.py:700: in test_predict_batch_with_mock_model
    with patch("transformers.pipeline", return_value=mock_pipeline):
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'transformers'
__________________ TestNLIService.test_predict_use_slow_model __________________
tests/test_ml_server.py:727: in test_predict_use_slow_model
    import torch
E   ModuleNotFoundError: No module named 'torch'
________________ TestNLIService.test_predict_model_load_failure ________________
tests/test_ml_server.py:767: in test_predict_model_load_failure
    with patch(
/usr/lib/python3.12/unittest/mock.py:1442: in __enter__
    self.target = self.getter()
                  ^^^^^^^^^^^^^
/usr/lib/python3.12/pkgutil.py:513: in resolve_name
    mod = importlib.import_module(modname)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
/usr/lib/python3.12/importlib/__init__.py:90: in import_module
    return _bootstrap._gcd_import(name[level:], package, level)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
<frozen importlib._bootstrap>:1387: in _gcd_import
    ???
<frozen importlib._bootstrap>:1360: in _find_and_load
    ???
<frozen importlib._bootstrap>:1324: in _find_and_load_unlocked
    ???
E   ModuleNotFoundError: No module named 'transformers'
=============================== warnings summary ===============================
tests/test_browser_search_provider.py::TestBrowserSearchProvider::test_search_success
tests/test_browser_search_provider.py::TestBrowserSearchProvider::test_search_captcha_detection
tests/test_browser_search_provider.py::TestCDPConnection::test_cdp_connection_success_sets_connection_mode
tests/test_browser_search_provider.py::TestCDPConnection::test_captcha_detection_includes_connection_mode
tests/test_browser_search_provider.py::TestSearchOptionsIntegration::test_search_with_options
tests/test_browser_search_provider.py::TestSearchOptionsIntegration::test_search_limit_applied
  /home/statuser/lancet/src/crawler/profile_audit.py:450: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    fonts=set(result.get("fonts", [])),
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_browser_search_provider.py::TestBrowserSearchProvider::test_search_success
tests/test_browser_search_provider.py::TestBrowserSearchProvider::test_search_captcha_detection
tests/test_browser_search_provider.py::TestCDPConnection::test_cdp_connection_success_sets_connection_mode
tests/test_browser_search_provider.py::TestCDPConnection::test_captcha_detection_includes_connection_mode
tests/test_browser_search_provider.py::TestSearchOptionsIntegration::test_search_with_options
tests/test_browser_search_provider.py::TestSearchOptionsIntegration::test_search_limit_applied
  /home/statuser/lancet/src/crawler/fetcher.py:176: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    await self._simulator.read_page(page, max_scrolls=5)
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_fetcher.py::TestBrowserFetcherHumanBehavior::test_fetch_with_human_behavior_enabled
  /usr/lib/python3.12/unittest/mock.py:2188: RuntimeWarning: coroutine 'AsyncMockMixin._execute_mock_call' was never awaited
    def __init__(self, name, parent):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

tests/test_ml_server.py::TestNLIService::test_predict_use_slow_model
  /home/statuser/lancet/.venv/lib/python3.12/site-packages/_pytest/unraisableexception.py:67: PytestUnraisableExceptionWarning: Exception ignored in: <function BaseSubprocessTransport.__del__ at 0x721031a62f20>
  
  Traceback (most recent call last):
    File "/usr/lib/python3.12/asyncio/base_subprocess.py", line 126, in __del__
      self.close()
    File "/usr/lib/python3.12/asyncio/base_subprocess.py", line 104, in close
      proto.pipe.close()
    File "/usr/lib/python3.12/asyncio/unix_events.py", line 767, in close
      self.write_eof()
    File "/usr/lib/python3.12/asyncio/unix_events.py", line 753, in write_eof
      self._loop.call_soon(self._call_connection_lost, None)
    File "/usr/lib/python3.12/asyncio/base_events.py", line 795, in call_soon
      self._check_closed()
    File "/usr/lib/python3.12/asyncio/base_events.py", line 541, in _check_closed
      raise RuntimeError('Event loop is closed')
  RuntimeError: Event loop is closed
  
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.
    warnings.warn(pytest.PytestUnraisableExceptionWarning(msg))

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_extractor.py::TestPDFExtraction::test_pdf_extraction_basic - ModuleNotFoundError: No module named 'fitz'
FAILED tests/test_extractor.py::TestPDFExtraction::test_pdf_extraction_triggers_ocr_for_low_text - ModuleNotFoundError: No module named 'fitz'
FAILED tests/test_extractor.py::TestPDFExtraction::test_pdf_extraction_force_ocr - ModuleNotFoundError: No module named 'fitz'
FAILED tests/test_extractor.py::TestOCREngines::test_paddleocr_extraction - ModuleNotFoundError: No module named 'PIL'
FAILED tests/test_extractor.py::TestOCREngines::test_tesseract_extraction_via_ocr_image - ModuleNotFoundError: No module named 'PIL'
FAILED tests/test_extractor.py::TestOCREngines::test_paddleocr_filters_low_confidence - ModuleNotFoundError: No module named 'PIL'
FAILED tests/test_extractor.py::TestOCRImage::test_ocr_image_from_data - ModuleNotFoundError: No module named 'PIL'
FAILED tests/test_extractor.py::TestOCRImage::test_ocr_image_falls_back_to_tesseract - ModuleNotFoundError: No module named 'PIL'
FAILED tests/test_extractor.py::TestOCRImage::test_ocr_image_no_engine_available - ModuleNotFoundError: No module named 'PIL'
FAILED tests/test_ml_server.py::TestEmbeddingService::test_encode_with_mock_model - ModuleNotFoundError: No module named 'sentence_transformers'
FAILED tests/test_ml_server.py::TestEmbeddingService::test_encode_model_load_failure - ModuleNotFoundError: No module named 'sentence_transformers'
FAILED tests/test_ml_server.py::TestRerankerService::test_rerank_with_mock_model - ModuleNotFoundError: No module named 'sentence_transformers'
FAILED tests/test_ml_server.py::TestRerankerService::test_rerank_model_load_failure - ModuleNotFoundError: No module named 'sentence_transformers'
FAILED tests/test_ml_server.py::TestNLIService::test_predict_with_mock_model - ModuleNotFoundError: No module named 'transformers'
FAILED tests/test_ml_server.py::TestNLIService::test_predict_batch_with_mock_model - ModuleNotFoundError: No module named 'transformers'
FAILED tests/test_ml_server.py::TestNLIService::test_predict_use_slow_model - ModuleNotFoundError: No module named 'torch'
FAILED tests/test_ml_server.py::TestNLIService::test_predict_model_load_failure - ModuleNotFoundError: No module named 'transformers'
= 17 failed, 2754 passed, 4 skipped, 23 deselected, 14 warnings in 69.56s (0:01:09) =
