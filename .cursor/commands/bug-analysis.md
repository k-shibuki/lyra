# bug-analysis

一般的なバグパターン・アンチパターンを調査し、修正する。

## 関連ルール
- コード実行時: @.cursor/rules/code-execution.mdc
- リファクタ関連: @.cursor/rules/refactoring.mdc

## ワークフロー概要

```
┌─────────────────────────────────────────────────────────────┐
│  1. 症状の特定    エラーメッセージ・再現手順を確認           │
│         ↓                                                    │
│  2. 原因調査      ログ・スタックトレースを分析               │
│         ↓                                                    │
│  3. パターン分類  既知のバグパターンに分類                   │
│         ↓                                                    │
│  4. 修正実装      パターンに基づいた修正                     │
│         ↓                                                    │
│  5. 検証          修正後の動作確認・回帰テスト               │
└─────────────────────────────────────────────────────────────┘
```

## よくあるバグパターン

### 1. 非同期処理の問題

| パターン | 症状 | 修正方法 |
|---------|------|---------|
| await忘れ | 処理が完了前に次へ進む | `await` を追加 |
| 競合状態 | 結果が不安定 | ロック or 直列化 |
| デッドロック | 処理がハング | タイムアウト追加 |

### 2. 型・データの問題

| パターン | 症状 | 修正方法 |
|---------|------|---------|
| None参照 | AttributeError | Optional チェック追加 |
| 型不一致 | TypeError | 型変換 or 型定義修正 |
| 空データ | IndexError, KeyError | 空チェック追加 |

### 3. リソース管理の問題

| パターン | 症状 | 修正方法 |
|---------|------|---------|
| リソースリーク | メモリ増加 | `with` 文 or `finally` |
| 接続枯渇 | タイムアウト | コネクションプール |
| ファイルロック | 書き込み失敗 | 排他制御 |

### 4. エラーハンドリングの問題

| パターン | 症状 | 修正方法 |
|---------|------|---------|
| 握りつぶし | 無言で失敗 | 適切な例外処理 |
| 広すぎるcatch | デバッグ困難 | 具体的な例外型 |
| リトライなし | 一時エラーで失敗 | リトライロジック追加 |

## 調査手順

### 1. 症状の特定

```bash
# 最近のエラーログを確認
podman exec lyra cat logs/app.log | tail -100

# 特定のエラーを検索
podman exec lyra grep -r "ERROR\|Exception" logs/
```

### 2. 原因調査

```bash
# スタックトレースを確認
# 関連するコードを読む
# 変数の状態を確認（printデバッグ or デバッガ）
```

### 3. パターンに基づいた修正

上記のパターン表を参照し、該当するパターンの修正方法を適用。

## 完了条件
- [ ] バグの原因が特定できた
- [ ] パターンに基づいた修正を実装した
- [ ] 修正後にバグが再現しないことを確認した
- [ ] 回帰テストがパスした

## 出力
- バグの症状と原因
- 該当したパターン
- 修正内容
- 検証結果
