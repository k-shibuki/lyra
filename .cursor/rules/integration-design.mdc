---
description: モジュール間の連動を設計・検証する際の規約
alwaysApply: false
---
# モジュール間連動設計ルール

## 位置づけ（規約と手順の分離）

- 本ファイルは **規約（ポリシー）** を定義する。
- 具体的な手順（出力物の作り方・進め方）は `@.cursor/commands/integration-design.md` を参照する。

## 目的

バイブコーディングで生じる「モジュール間の連動ができておらず、全体として機能するプロダクトになっていない」問題を解決する。

## 実装前の必須確認事項

### 0.1. 仕様書の確認

1. **docs/requirements.mdの該当セクションを確認**
   - 実装対象機能に関連するセクションを特定
   - 仕様の要件を正確に理解する

2. **準拠性チェック**
   - 実装案が仕様書の要件を満たしているか確認
   - 仕様書に明記されていない動作を追加しない

### 0.2. コードベースの理解

1. **関連モジュールの調査** - 既存コードを調査し、パターンを確認
2. **依存関係の確認** - 循環依存がないか確認
3. **一貫性の確認** - 命名規則、エラーハンドリング、ログ出力形式

### 0.3. コーディング規約の確認

- **コメントは英語で統一**（docstringも英語）
- **実装計画書の章番号を含めない**
- **docstringはGoogleスタイル**

## 4ステップ設計プロセス

### ステップ1: シーケンス図の作成

- 対象モジュール間のシーケンス図を作成
- データ型を明示（Pydanticモデル推奨）
- 保存場所: `docs/debug/`

### ステップ2: 型定義（Pydantic）

- モジュール間のデータ構造をPydanticモデルで定義
- `src/{module}/schemas.py` に配置

### ステップ3: デバッグ用スクリプトの作成

- `tests/scripts/debug_{feature}_flow.py` に配置
- 各ステップでデータの型・内容を検証
- **新規パラメータ/フィールドがある場合**: 入口→各モジュール境界→出口の各地点で、その値が期待通りに保持/変換されていること（必要なら“効いていること”）を検証する

### ステップ4: シーケンス図の更新

- 修正後の正しいデータフローを記録

## チェックリスト

### 実装前
- [ ] 仕様書確認
- [ ] コードベース理解
- [ ] 依存関係確認
- [ ] コーディング規約確認

### 設計・実装
- [ ] シーケンス図作成
- [ ] Pydanticモデル定義
- [ ] **追加したパラメータ/フィールドの伝播表**（どこで受け取り、どこに渡し、どこで効果が出るか）を作る
- [ ] デバッグスクリプト作成・実行
- [ ] デバッグスクリプトで **伝播表の各境界** を検証（未配線なら失敗する観測点を置く）
- [ ] 型チェック

### 実装後
- [ ] 仕様準拠性確認
- [ ] コメント言語確認
- [ ] 一貫性確認
- [ ] Lintエラー確認
