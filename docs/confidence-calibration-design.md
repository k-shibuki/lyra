# Confidence & Calibration Design

**Date:** 2025-12-30
**Status:** Proposal (v4 - Implementation Gaps Analysis integrated)
**Related:**
- ADR-0005: Evidence Graph Structure
- ADR-0011: LoRA Fine-tuning Strategy
- ADR-0012: Feedback Tool Design
- `src/filter/evidence_graph.py`
- `src/utils/calibration.py`

---

## 0. ã“ã®æ–‡æ›¸ã®ä½ç½®ã¥ã‘

ã“ã®æ–‡æ›¸ã¯ã€Œconfidence / calibrationã€ã«é–¢ã™ã‚‹ **ç¾çŠ¶åˆ†æï¼ˆas-isï¼‰** ã¨ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«å¯¾ã™ã‚‹**æ”¹å–„ææ¡ˆï¼ˆto-beï¼‰** ã‚’ã¾ã¨ã‚ã‚‹ã€‚

## 1. æ¦‚å¿µå®šç¾©

### 1.1 ã‚³ã‚¢ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

Lyra ã®ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã‚°ãƒ©ãƒ•ã¯ä»¥ä¸‹ã®4ã¤ã®ä¸»è¦ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã§æ§‹æˆã•ã‚Œã‚‹ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Evidence Graph                                  â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚   Page   â”‚ â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Fragment â”‚ â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Claim   â”‚             â”‚
â”‚   â”‚          â”‚ contains â”‚          â”‚ supports â”‚          â”‚             â”‚
â”‚   â”‚ (global) â”‚          â”‚ (global) â”‚ refutes  â”‚(task-scoped)           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ neutral  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â”‚                      â”‚                    â–²                    â”‚
â”‚        â”‚                      â”‚         Edge       â”‚                    â”‚
â”‚        â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚        â”‚                           (global)                             â”‚
â”‚        â”‚                                                                â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                          â”‚
â”‚   â”‚  Domain  â”‚  (å‚ç…§æƒ…å ±ã®ã¿ã€Confidence è¨ˆç®—ã«ã¯ä½¿ç”¨ã—ãªã„)            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.1.1 Pageï¼ˆãƒšãƒ¼ã‚¸ï¼‰

**å®šç¾©**: ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã‚ŒãŸ Web ãƒšãƒ¼ã‚¸ã¾ãŸã¯å­¦è¡“è«–æ–‡
**ã‚¹ã‚³ãƒ¼ãƒ—**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆ`url UNIQUE`ã€ã‚¿ã‚¹ã‚¯é–“ã§å†åˆ©ç”¨å¯èƒ½ï¼‰
**DB ãƒ†ãƒ¼ãƒ–ãƒ«**: `pages`

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| `id` | TEXT | ä¸€æ„è­˜åˆ¥å­ |
| `url` | TEXT | æ­£è¦åŒ–ã•ã‚ŒãŸ URLï¼ˆUNIQUEï¼‰ |
| `domain` | TEXT | ãƒ‰ãƒ¡ã‚¤ãƒ³å |
| `page_type` | TEXT | article, knowledge, forum, academic, etc. |
| `paper_metadata` | TEXT (JSON) | å­¦è¡“ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ `{year, doi, venue, citation_count, source_api}` |
| `title` | TEXT | ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ« |
| `fetched_at` | DATETIME | å–å¾—æ—¥æ™‚ |

**å­¦è¡“ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆpaper_metadata JSONï¼‰**:
```json
{
  "year": 2023,
  "doi": "10.1234/example.2023",
  "venue": "Nature",
  "citation_count": 150,
  "source_api": "semantic_scholar",
  "paper_id": "abc123"
}
```

#### 1.1.2 Fragmentï¼ˆãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆï¼‰

**å®šç¾©**: ãƒšãƒ¼ã‚¸ã‹ã‚‰æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆæ–­ç‰‡
**ã‚¹ã‚³ãƒ¼ãƒ—**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆ`page_id` çµŒç”±ã§ Page ã«ç´ã¥ãï¼‰
**DB ãƒ†ãƒ¼ãƒ–ãƒ«**: `fragments`

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| `id` | TEXT | ä¸€æ„è­˜åˆ¥å­ |
| `page_id` | TEXT | è¦ª Page ã¸ã®å‚ç…§ |
| `fragment_type` | TEXT | paragraph, heading, list, table, quote, figure, code |
| `text_content` | TEXT | æŠ½å‡ºã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ |
| `heading_hierarchy` | TEXT (JSON) | è¦‹å‡ºã—éšå±¤ `[{level, text}, ...]` |
| `position` | INTEGER | ãƒšãƒ¼ã‚¸å†…ã®é †åº |
| `bm25_score` | REAL | BM25 ã‚¹ã‚³ã‚¢ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°æ™‚ï¼‰ |
| `embed_score` | REAL | åŸ‹ã‚è¾¼ã¿é¡ä¼¼åº¦ã‚¹ã‚³ã‚¢ |
| `rerank_score` | REAL | ãƒªãƒ©ãƒ³ã‚«ãƒ¼ã‚¹ã‚³ã‚¢ |

#### 1.1.3 Claimï¼ˆä¸»å¼µï¼‰

**å®šç¾©**: ã‚¿ã‚¹ã‚¯ã«å¯¾ã—ã¦æŠ½å‡ºã¾ãŸã¯ç”Ÿæˆã•ã‚ŒãŸæ¤œè¨¼å¯¾è±¡ã®ä¸»å¼µ
**ã‚¹ã‚³ãƒ¼ãƒ—**: ã‚¿ã‚¹ã‚¯ã‚¹ã‚³ãƒ¼ãƒ—ï¼ˆ`task_id` ã§åˆ†é›¢ï¼‰
**DB ãƒ†ãƒ¼ãƒ–ãƒ«**: `claims`

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| `id` | TEXT | ä¸€æ„è­˜åˆ¥å­ |
| `task_id` | TEXT | æ‰€å±ã‚¿ã‚¹ã‚¯ |
| `claim_text` | TEXT | ä¸»å¼µã®ãƒ†ã‚­ã‚¹ãƒˆ |
| `claim_type` | TEXT | fact, opinion, prediction |
| `granularity` | TEXT | atomic, composite |
| `claim_confidence` | REAL | **llm-confidence**ï¼ˆLLM è‡ªå·±å ±å‘Šã€‚ãƒ™ã‚¤ã‚ºæ›´æ–°ã®å…¥åŠ›ã«ã¯ä½¿ã‚ãªã„ãŒã€ææ–™æ•´å½¢ã§ä¸¦ã³æ›¿ãˆ/ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ä½¿ã‚ã‚Œå¾—ã‚‹ï¼‰ |
| `claim_adoption_status` | TEXT | adopted, pending, not_adopted |
| `supporting_count` | INTEGER | æ”¯æŒã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹æ•° |
| `refuting_count` | INTEGER | åè«–ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹æ•° |

#### 1.1.4 Edgeï¼ˆã‚¨ãƒƒã‚¸ï¼‰

**å®šç¾©**: ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é–“ã®é–¢ä¿‚ï¼ˆè¨¼æ‹ é–¢ä¿‚ã€å¼•ç”¨é–¢ä¿‚ï¼‰
**ã‚¹ã‚³ãƒ¼ãƒ—**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼ˆãŸã ã— `task_id` ã§ã‚¹ãƒ©ã‚¤ã‚¹å¯èƒ½ï¼‰
**DB ãƒ†ãƒ¼ãƒ–ãƒ«**: `edges`

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
|-----------|-----|------|
| `id` | TEXT | ä¸€æ„è­˜åˆ¥å­ |
| `source_type` | TEXT | claim, fragment, page |
| `source_id` | TEXT | ã‚½ãƒ¼ã‚¹ãƒãƒ¼ãƒ‰ ID |
| `target_type` | TEXT | claim, fragment, page |
| `target_id` | TEXT | ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒãƒ¼ãƒ‰ ID |
| `relation` | TEXT | **supports, refutes, neutral, cites** |
| `nli_label` | TEXT | NLI ãƒ¢ãƒ‡ãƒ«ã®åˆ¤å®šãƒ©ãƒ™ãƒ« |
| `nli_confidence` | REAL | **nli-confidence**ï¼ˆãƒ™ã‚¤ã‚ºæ›´æ–°ã®å…¥åŠ›ï¼‰ |
| `confidence` | REAL | ç·åˆä¿¡é ¼åº¦ï¼ˆãƒ¬ã‚¬ã‚·ãƒ¼ï¼‰ |
| `citation_source` | TEXT | å¼•ç”¨å…ƒ API (semantic_scholar, openalex, extraction) |
| `edge_human_corrected` | BOOLEAN | äººé–“ã«ã‚ˆã‚‹ä¿®æ­£æ¸ˆã¿ãƒ•ãƒ©ã‚° |

**é–¢ä¿‚ã‚¿ã‚¤ãƒ—ï¼ˆRelationTypeï¼‰**:

| é–¢ä¿‚ | æ–¹å‘ | èª¬æ˜ |
|------|------|------|
| `supports` | Fragment â†’ Claim | ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆãŒä¸»å¼µã‚’æ”¯æŒ |
| `refutes` | Fragment â†’ Claim | ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆãŒä¸»å¼µã‚’åè«– |
| `neutral` | Fragment â†’ Claim | é–¢ä¿‚ä¸æ˜ |
| `cites` | Page â†’ Page | å¼•ç”¨é–¢ä¿‚ |

---

## 2. Confidence ã®3ã¤ã®ç¨®é¡

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€Œconfidenceã€ã¨ã„ã†ç”¨èªãŒ**3ã¤ã®ç•°ãªã‚‹æ„å‘³**ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚

### 2.1 ç”¨èªãƒãƒƒãƒ—

| ç”¨èª | å®šç¾© | ç”Ÿæˆå…ƒ | DB ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | ç”¨é€” | æ ¡æ­£å¯èƒ½æ€§ |
|------|------|--------|---------------|------|------------|
| **llm-confidence** | LLM ãŒæŠ½å‡ºæ™‚ã«è‡ªå·±å ±å‘Šã™ã‚‹ç¢ºä¿¡åº¦ï¼ˆæŠ½å‡ºã®è‡ªå·±è©•ä¾¡ï¼‰ | Ollama (extract_claims.j2) | `claims.claim_confidence` | ä¸¦ã³æ›¿ãˆãƒ»ä½è¨¼æ‹ æ™‚ã®æš«å®šè¡¨ç¤ºãªã©ï¼ˆâ€»çœŸå½ã®æ ¹æ‹ ã¨ã—ã¦ã¯æ‰±ã‚ãªã„ï¼‰ | ä½ |
| **nli-confidence** | NLI ãƒ¢ãƒ‡ãƒ«ã«ã‚ˆã‚‹è¨¼æ‹ é–¢ä¿‚åˆ¤å®šã®ç¢ºä¿¡åº¦ | Transformers NLI (nli_judge) | `edges.nli_confidence` | ãƒ™ã‚¤ã‚ºæ›´æ–°ã®å…¥åŠ›ï¼ˆè¨¼æ‹ ã®é‡ã¿ï¼‰ | ä¸­ã€œé«˜ï¼ˆãŸã ã—æ ¡æ­£é©ç”¨ã¯åˆ¥é€”é…ç·šãŒå¿…è¦ï¼‰ |
| **bayesian-confidence** | å…¨è¨¼æ‹ ã‚’é›†ç´„ã—ãŸä¸»å¼µã®ä¿¡é ¼åº¦ | `calculate_claim_confidence()` | è¨ˆç®—å€¤ï¼ˆéæ°¸ç¶šï¼‰ | ãƒ¬ãƒãƒ¼ãƒˆã€UI | å°å‡ºå€¤ï¼ˆN/Aï¼‰ |

### 2.2 æ„å‘³è«–çš„ãªé•ã„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  llm-confidence                                                          â”‚
â”‚  â”œâ”€â”€ å•ã„: ã€Œã“ã®æŠ½å‡ºã¯æ­£ã—ã„ã‹ï¼Ÿã€                                        â”‚
â”‚  â”œâ”€â”€ æ€§è³ª: æŠ½å‡ºå“è³ªã®è‡ªå·±è©•ä¾¡                                              â”‚
â”‚  â”œâ”€â”€ å€¤åŸŸ: 0.0 - 1.0ï¼ˆLLM ã®ä¸»è¦³çš„åˆ¤æ–­ï¼‰                                   â”‚
â”‚  â”œâ”€â”€ æ ¡æ­£å¯èƒ½æ€§: ä½                                                        â”‚
â”‚  â”‚   â””â”€â”€ ç†ç”±: LoRA ãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°éç¾å®Ÿçš„                            â”‚
â”‚  â”‚   â””â”€â”€ ç†ç”±: ã‚µãƒ³ãƒ—ãƒ«åé›†ã‚³ã‚¹ãƒˆé«˜                                         â”‚
â”‚  â”‚   â””â”€â”€ ç†ç”±: LLM ã®è‡ªå·±è©•ä¾¡ã¯æœ¬è³ªçš„ã«ä¸å®‰å®š                               â”‚
â”‚  â””â”€â”€ ç¾çŠ¶: ãƒ™ã‚¤ã‚ºæ›´æ–°ã®å…¥åŠ›ã«ã¯ä½¿ã‚ãªã„ï¼ˆ`SearchExecutor._persist_claim()` ã®ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜ç¤ºï¼‰â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  nli-confidence                                                          â”‚
â”‚  â”œâ”€â”€ å•ã„: ã€ŒFragment ã¯ Claim ã‚’æ”¯æŒ/åè«–ã™ã‚‹ã‹ï¼Ÿã€                        â”‚
â”‚  â”œâ”€â”€ æ€§è³ª: è¨¼æ‹ é–¢ä¿‚ã®åˆ¤å®šç¢ºç‡ï¼ˆNLI ãƒ¢ãƒ‡ãƒ«ã® softmax å‡ºåŠ›ï¼‰                  â”‚
â”‚  â”œâ”€â”€ å€¤åŸŸ: 0.0 - 1.0ï¼ˆDeBERTa-v3 ã®ãƒ¢ãƒ‡ãƒ«å‡ºåŠ›ï¼‰                            â”‚
â”‚  â”œâ”€â”€ æ ¡æ­£å¯èƒ½æ€§: ä¸­ã€œé«˜                                                    â”‚
â”‚  â”‚   â”œâ”€â”€ Platt Scaling: P = 1 / (1 + exp(A*logit + B))                   â”‚
â”‚  â”‚   â”œâ”€â”€ Temperature Scaling: P = sigmoid(logit / T)                     â”‚
â”‚  â”‚   â””â”€â”€ LoRA Fine-tuning: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰é©å¿œå­¦ç¿’              â”‚
â”‚  â””â”€â”€ ç¾çŠ¶: ãƒ™ã‚¤ã‚ºæ›´æ–°ã§ä½¿ç”¨ã€‚æ ¡æ­£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å­˜åœ¨ã™ã‚‹ãŒã€NLIæ¨è«–çµŒè·¯ã¸ã®é©ç”¨ã¯æœªé…ç·šã€‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  bayesian-confidence                                                     â”‚
â”‚  â”œâ”€â”€ å•ã„: ã€Œã“ã®ä¸»å¼µã¯çœŸã‹ï¼Ÿã€                                            â”‚
â”‚  â”œâ”€â”€ æ€§è³ª: Beta åˆ†å¸ƒã®æœŸå¾…å€¤ï¼ˆãƒ™ã‚¤ã‚ºäº‹å¾Œç¢ºç‡ï¼‰                             â”‚
â”‚  â”œâ”€â”€ å€¤åŸŸ: 0.0 - 1.0ï¼ˆäº‹å‰åˆ†å¸ƒ Beta(1,1) ã‹ã‚‰ã®æ›´æ–°ï¼‰                      â”‚
â”‚  â”œâ”€â”€ è¨ˆç®—: confidence = alpha / (alpha + beta)                           â”‚
â”‚  â”‚   â””â”€â”€ alpha += Î£(nli_confidence for supports)                        â”‚
â”‚  â”‚   â””â”€â”€ beta  += Î£(nli_confidence for refutes)                         â”‚
â”‚  â””â”€â”€ ç¾çŠ¶: get_materials(), ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã§ä½¿ç”¨                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 3.1 æ¤œç´¢ã‹ã‚‰ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹è“„ç©ã¾ã§

```
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   User Query    â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Search Engines â”‚  DuckDuckGo, Brave, Google
                              â”‚    + Academic   â”‚  Semantic Scholar, OpenAlex
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   SERP Items    â”‚  æ¤œç´¢çµæœãƒªã‚¹ãƒˆ
                              â”‚    (serp_items) â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Page Fetch    â”‚  HTTP/Browser ã‚¯ãƒ­ãƒ¼ãƒ«
                              â”‚     (pages)     â”‚  WARC ä¿å­˜
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   Extraction    â”‚  ãƒ†ã‚­ã‚¹ãƒˆæŠ½å‡º
                              â”‚   (fragments)   â”‚  è¦‹å‡ºã—éšå±¤ä¿æŒ
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                 â”‚                 â”‚
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚   Multi-Stage     â”‚       â”‚       â”‚  Claim Extraction â”‚
           â”‚     Ranking       â”‚       â”‚       â”‚   (Ollama LLM)    â”‚
           â”‚ BM25 â†’ Embed â†’    â”‚       â”‚       â”‚                   â”‚
           â”‚ Reranker â†’ Domain â”‚       â”‚       â”‚ llm-confidence    â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                 â”‚                 â”‚
                     â”‚                 â”‚                 â–¼
                     â”‚                 â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚                 â”‚       â”‚      claims         â”‚
                     â”‚                 â”‚       â”‚  (task-scoped)      â”‚
                     â”‚                 â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                 â”‚                 â”‚
                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚   NLI Judgment  â”‚  Transformers NLI (DeBERTaç³»)
                              â”‚   (nli_judge)   â”‚  Fragment â†” Claim
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚      edges      â”‚  nli_label
                              â”‚  (evidence)     â”‚  nli_confidence
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ Bayesian Update â”‚  calculate_claim_confidence()
                              â”‚  Beta(Î±, Î²)     â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚
                                       â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚ bayesian-       â”‚  Reports
                              â”‚ confidence      â”‚  Materials
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ãƒ¢ãƒ‡ãƒ«åˆ¥ã®å½¹å‰²

| ãƒ¢ãƒ‡ãƒ« | ç¨®é¡ | ç”¨é€” | å‡ºåŠ› | Confidence ã¸ã®å½±éŸ¿ |
|--------|------|------|------|---------------------|
| **BM25** | èªå½™çš„ | ç¬¬1æ®µãƒ©ãƒ³ã‚­ãƒ³ã‚° | `bm25_score` | ãªã—ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰ |
| **BGE-M3** | Embedding | ç¬¬2æ®µãƒ©ãƒ³ã‚­ãƒ³ã‚° | `embed_score` | ãªã—ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰ |
| **BGE-Reranker-v2-m3** | Cross-Encoder | ç¬¬3æ®µãƒ©ãƒ³ã‚­ãƒ³ã‚° | `rerank_score` | ãªã—ï¼ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ï¼‰ |
| **Ollama (Qwen2.5-3B)** | LLM | Claim æŠ½å‡º | `claim_confidence` | ãƒ™ã‚¤ã‚ºæ›´æ–°ã®å…¥åŠ›ã«ã¯ã—ãªã„ï¼ˆãŸã ã—ä¿æŒã•ã‚Œã‚‹ï¼‰ |
| **Transformers NLI (DeBERTaç³»)** | NLI classifier | è¨¼æ‹ åˆ¤å®š | `nli_confidence` | **ãƒ™ã‚¤ã‚ºæ›´æ–°ã®å…¥åŠ›** |

### 3.3 ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©³ç´°

```python
# å¤šæ®µãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆ`src/filter/ranking.py`ï¼‰

# Stage 1: BM25 (keyword matching)
bm25_scores = bm25_ranker.get_scores(query)

# Stage 2: Embedding Similarity (semantic)
embed_scores = await embedding_ranker.get_scores(query, texts)

# Stage 3: Combined Score
combined_score = 0.3 * bm25_score + 0.7 * embed_score  # é‡ã¿ä»˜ã‘

# Stage 4: Cross-Encoder Reranker
rerank_scores = await reranker.rerank(query, texts, top_k)

# Domain Category Weight (ranking adjustment only)
# Weights live in `src/utils/domain_policy.py` (CATEGORY_WEIGHTS)
final_score = rerank_score * category_weight
```

**é‡è¦**: Domain Category ã¯**ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª¿æ•´ã®ã¿**ã«ä½¿ç”¨ã€‚Confidence è¨ˆç®—ã«ã¯ä½¿ç”¨ã—ãªã„ï¼ˆADR-0005ï¼‰ã€‚

### 3.4 MCPãƒ„ãƒ¼ãƒ«ã§ã®å—ã‘æ¸¡ã—ï¼ˆãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¸ã®æ¥ç¶šï¼‰

æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã«ãŠã„ã¦ã€ŒæŠ½å‡ºå“è³ªï¼ˆllm-confidenceï¼‰ã€ã‚’æ´»ç”¨ã™ã‚‹ã«ã¯ã€**MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆé«˜æ¨è«–LLMï¼‰ãŒæ©Ÿæ¢°çš„ã«è§£é‡ˆã§ãã‚‹å½¢ã§ææ–™ã«è¼‰ã‚‹ã“ã¨**ãŒå¿…è¦ã§ã‚ã‚‹ã€‚
çµè«–ã¨ã—ã¦ã€ä¸»çµŒè·¯ã¯ `get_materials` ã§ã‚ã‚‹ï¼ˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒ»æ¬¡ã‚¯ã‚¨ãƒªé¸å®šã®ä¸¡æ–¹ã®å…¥åŠ›ã«ãªã‚‹ï¼‰ã€‚

#### 3.4.1 As-Isï¼ˆç¾çŠ¶ï¼‰

- **MCPãƒ„ãƒ¼ãƒ«**
  - `get_materials`: claimã”ã¨ã« `confidence/uncertainty/controversy/evidence_count/...` ã‚’è¿”ã™ã€‚
  - `queue_searches`: æ¬¡ã®æ¢ç´¢ã‚¯ã‚¨ãƒªã‚’æŠ•å…¥ã™ã‚‹ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒæˆ¦ç•¥æ±ºå®šï¼‰ã€‚
  - `get_status`: æ¢ç´¢é€²æ—ãƒ»äºˆç®—ãƒ»ã‚­ãƒ¥ãƒ¼ç­‰ã®çŠ¶æ…‹å–å¾—ã€‚
  - `feedback`: claim/edge/domainã®ä¿®æ­£ï¼ˆæ•™å¸«ãƒ‡ãƒ¼ã‚¿ã®ç¨®ï¼‰ã€‚
  - `calibration_metrics`: çµ±è¨ˆ/å±¥æ­´ã®å‚ç…§ï¼ˆget_stats/get_evaluationsï¼‰ã€‚
- **å•é¡Œ**
  - `get_materials.claims[].confidence` ã¯å®Ÿè³ª **bayesian-confidenceï¼ˆè¨¼æ‹ é›†ç´„å¾Œï¼‰**ã§ã‚ã‚Šã€`claims.claim_confidence`ï¼ˆllm-confidenceï¼‰ãŒ
    **åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ã—ã¦éœ²å‡ºã—ã¦ã„ãªã„**ã€‚
  - çµæœã¨ã—ã¦ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€Œãã®claimãŒæŠ½å‡ºå“è³ªã¨ã—ã¦æ€ªã—ã„/å …ã„ã€ã¨ã„ã†ä¿¡å·ã‚’**å®‰å®šã«å—ã‘å–ã‚Œãªã„**ã€‚

#### 3.4.2 To-Beï¼ˆææ¡ˆï¼šMCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸æ¸¡ã™å¥‘ç´„ï¼‰

`get_materials` ã® `claims[]` ã«ã€**"çœŸå½æ¨å®š"ã¨"æŠ½å‡ºå“è³ª"ã®åˆ†é›¢**ã‚’æ˜ç¤ºã™ã‚‹ã€‚

**å®Ÿè£…æ–¹é‡ï¼ˆç¢ºå®šï¼‰**:
- **å¾Œæ–¹äº’æ›æ€§ã¯ä¸è¦**ï¼ˆç ´å£Šçš„å¤‰æ›´ã¨ã—ã¦å®Ÿæ–½ï¼‰
- **å‰ææ¡ä»¶**: E2Eãƒ‡ãƒãƒƒã‚°ãŒå®Œäº†ã—ã¦ã‹ã‚‰ç€æ‰‹ã™ã‚‹
- ç†ç”±: E2Eå®Œäº†å‰ã«å¥‘ç´„ã‚’å¤‰ãˆã‚‹ã¨ã€ãƒ‡ãƒãƒƒã‚°å¯¾è±¡ãŒå¢—ãˆåæŸã—ãªã„

- **ææ¡ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆä¾‹ï¼‰**
  - `bayesian_confidence`: ç¾åœ¨ `confidence` ã«å…¥ã£ã¦ã„ã‚‹å€¤ï¼ˆè¨¼æ‹ é›†ç´„å¾Œï¼‰
  - `llm_confidence`: `claims.claim_confidence`ï¼ˆæŠ½å‡ºå“è³ªã®è‡ªå·±è©•ä¾¡ã®ç”Ÿå€¤ï¼‰
  - `confidence_source`: `bayesian | llm_fallback`ï¼ˆæ··åŒé˜²æ­¢ï¼‰
  - `extraction_quality_flag`: `low | medium | high`ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®æ„æ€æ±ºå®šã‚’å˜ç´”åŒ–ï¼‰

#### 3.4.3 æ¬¡ã‚¯ã‚¨ãƒªé¸å®šï¼ˆqueue_searchesï¼‰ã‚’ã©ã†æ”¹å–„ã™ã‚‹ã‹

ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ `get_materials` ã®å„claimã‚’ã€Œæ¢ç´¢ä¾¡å€¤ã€ã§ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã§ãã‚‹ã€‚ä¾‹:

- **Case A: llm_confidence ä½ + evidence_count ä½**
  - è§£é‡ˆ: claimè‡ªä½“ãŒä¸å®‰å®š/æŠ½å‡ºãƒŸã‚¹ã®å¯èƒ½æ€§ãŒé«˜ã„ã€‚æ¢ç´¢äºˆç®—ã‚’æŠ•ä¸‹ã—ã¦ã‚‚å›åã§ããªã„ç¢ºç‡ãŒé«˜ã„ã€‚
  - æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ãã®claimã¯â€œè¦ç¢ºèªâ€æ ã«éš”é›¢ã€‚åˆ¥claimã¸æ¢ç´¢ã‚’å‰²ã‚Šå½“ã¦ã‚‹ï¼åŒãƒˆãƒ”ãƒƒã‚¯ã®ä¸€æ¬¡è³‡æ–™ã‚’å¢—ã‚„ã™ã‚¯ã‚¨ãƒªã¸ã€‚
- **Case B: llm_confidence é«˜ + (uncertainty é«˜ or controversy é«˜)**
  - è§£é‡ˆ: æŠ½å‡ºã¯å®‰å®šã ãŒã€è¨¼æ‹ ãŒä¸è¶³/å¯¾ç«‹ã—ã¦ã„ã‚‹ï¼ˆç ”ç©¶ã¨ã—ã¦é‡è¦ãªè«–ç‚¹ã«ãªã‚Šå¾—ã‚‹ï¼‰ã€‚
  - æ¬¡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: åè¨¼æ¢ç´¢ã‚„ç‹¬ç«‹ã‚½ãƒ¼ã‚¹è¿½åŠ ã®ã‚¯ã‚¨ãƒªã‚’ `queue_searches` ã«æŠ•å…¥ã€‚
- **Case C: llm_confidence é«˜ + bayesian_confidence é«˜ + uncertainty ä½**
  - è§£é‡ˆ: æŠ½å‡ºã‚‚è¨¼æ‹ ã‚‚å …ã„ã€‚æ¢ç´¢ã‚’æ‰“ã¡åˆ‡ã‚Šã€åˆ¥è«–ç‚¹ã¸äºˆç®—ã‚’å›ã™å€™è£œã€‚

#### 3.4.4 æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆï¼ˆé«˜æ¨è«–LLMï¼‰ã‚’ã©ã†è‰¯ãã™ã‚‹ã‹

- **æ–­è¨€å¼·åº¦ã®åˆ¶å¾¡**: â€œè¨¼æ‹ ãŒå¼±ã„â€ã®ã‹â€œæŠ½å‡ºãŒæ€ªã—ã„â€ã®ã‹ã‚’åˆ†é›¢ã—ã€æ–‡ç« ã®ç¢ºä¿¡åº¦è¡¨ç¾ã‚’é©åˆ‡ã«ã™ã‚‹ã€‚
- **ãƒ¬ãƒ“ãƒ¥ãƒ¼èª˜å°**: `llm_confidence` ä½ã„claimã‚’ã€Œå…ƒæ–‡è„ˆã®ç¢ºèªãŒå¿…è¦ã€ã¨æ˜ç¤ºã—ã€èª¤ã£ãŸæ–­è¨€ã®æ··å…¥ã‚’é˜²ãã€‚
- **è«–äº‰ç‚¹ã®æŠ½å‡º**: `controversy` é«˜ã„ãŒ `llm_confidence` é«˜ã„ã‚±ãƒ¼ã‚¹ã‚’ã€å­¦è¡“çš„ã«ä¾¡å€¤ã®ã‚ã‚‹å¯¾ç«‹ç‚¹ã¨ã—ã¦æ•´ç†ã§ãã‚‹ã€‚

---

## 4. ãƒ™ã‚¤ã‚ºæ›´æ–°ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 

### 4.1 æ•°å­¦çš„åŸºç¤

**Beta åˆ†å¸ƒã«ã‚ˆã‚‹ãƒ™ã‚¤ã‚ºæ›´æ–°**:

```
Prior:     Beta(1, 1)     â† ç„¡æƒ…å ±äº‹å‰åˆ†å¸ƒ
Posterior: Beta(Î±, Î²)     â† è¨¼æ‹ ã«ã‚ˆã‚‹æ›´æ–°

Î± = 1 + Î£(nli_confidence for SUPPORTS edges)
Î² = 1 + Î£(nli_confidence for REFUTES edges)

confidence  = Î± / (Î± + Î²)                           â† æœŸå¾…å€¤
variance    = (Î± Ã— Î²) / ((Î± + Î²)Â² Ã— (Î± + Î² + 1))   â† åˆ†æ•£
uncertainty = âˆšvariance                             â† æ¨™æº–åå·®
controversy = min(Î±-1, Î²-1) / (Î± + Î² - 2)           â† å¯¾ç«‹åº¦
```

### 4.2 å®Ÿè£…ï¼ˆsrc/filter/evidence_graph.py:344-474ï¼‰

```python
def calculate_claim_confidence(self, claim_id: str) -> dict[str, Any]:
    evidence = self.get_all_evidence(claim_id)

    # Prior: Beta(1, 1)
    alpha = 1.0
    beta = 1.0

    for relation, items in evidence.items():
        for e in items:
            nli_conf = e.get("nli_confidence")

            if relation == "supports" and nli_conf > 0:
                alpha += nli_conf     # æ”¯æŒè¨¼æ‹  â†’ Î± ã‚’å¢—åŠ 
            elif relation == "refutes" and nli_conf > 0:
                beta += nli_conf      # åè«–è¨¼æ‹  â†’ Î² ã‚’å¢—åŠ 
            # NEUTRAL: æ›´æ–°ãªã—ï¼ˆæƒ…å ±ãªã—ï¼‰

    confidence = alpha / (alpha + beta)
    variance = (alpha * beta) / ((alpha + beta)**2 * (alpha + beta + 1))
    uncertainty = math.sqrt(variance)

    total_evidence = alpha + beta - 2.0
    controversy = min(alpha - 1.0, beta - 1.0) / total_evidence if total_evidence > 0 else 0.0

    # NOTE:
    # - The real implementation includes rounding, evidence_count,
    #   and year/DOI/venue enrichment when available.
    # - This snippet is for conceptual correspondence only.
```

### 4.3 å‡ºåŠ›å¥‘ç´„ï¼ˆsrc/filter/schemas.py:40-59ï¼‰

```python
class ClaimConfidenceAssessment(BaseModel):
    ...
```

---

## 5. NLI æ ¡æ­£ã‚·ã‚¹ãƒ†ãƒ 

### 5.0 å®Ÿè£…ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ¦‚è¦

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | è©³ç´° |
|---------------|:----------:|------|
| **æ ¡æ­£ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ** | âœ… å®Ÿè£…æ¸ˆã¿ | Platt Scaling, Temperature Scaling |
| **è©•ä¾¡æŒ‡æ¨™** | âœ… å®Ÿè£…æ¸ˆã¿ | Brier Score, ECE |
| **åŠ£åŒ–æ¤œçŸ¥ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯** | âœ… å®Ÿè£…æ¸ˆã¿ | CalibrationHistory ã‚¯ãƒ©ã‚¹ |
| **NLIæ¨è«–ã¸ã®é©ç”¨** | âš ï¸ **æœªé…ç·š** | `nli.py` ã§ `calibrate()` ãŒå‘¼ã°ã‚Œã¦ã„ãªã„ |
| **è©•ä¾¡çµæœã®æ°¸ç¶šåŒ–** | âš ï¸ **æœªæ•´å‚™** | `calibration_evaluations` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã® INSERT ãªã— |
| **MCPãƒ„ãƒ¼ãƒ«** | âœ… å®Ÿè£…æ¸ˆã¿ | `calibration_metrics` (get_stats/get_evaluations) |

**Critical Issue**: æ ¡æ­£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯å®Œæˆã—ã¦ã„ã‚‹ãŒã€NLIæ¨è«–çµŒè·¯ï¼ˆ`src/filter/nli.py`ï¼‰ã¸ã®é©ç”¨ãŒ**é…ç·šã•ã‚Œã¦ã„ãªã„**ã€‚
è©³ç´°ã¯ **Appendix D.7** ã‚’å‚ç…§ã€‚

### 5.1 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        NLI Calibration Pipeline                          â”‚
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚   â”‚ NLI Model   â”‚â”€â”€â”€â”€â–ºâ”‚ Raw Prob    â”‚â”€â”€â”€â”€â–ºâ”‚ Calibrator  â”‚              â”‚
â”‚   â”‚ (DeBERTa)   â”‚     â”‚ (0.0-1.0)   â”‚     â”‚             â”‚              â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                   â”‚                     â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                              â”‚                    â”‚                    â”‚â”‚
â”‚                              â–¼                    â–¼                    â–¼â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚                     â”‚   Platt     â”‚      â”‚ Temperature â”‚     â”‚ LoRA   â”‚â”‚
â”‚                     â”‚  Scaling    â”‚      â”‚  Scaling    â”‚     â”‚(Future)â”‚â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                              â”‚                    â”‚                     â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                   â”‚                     â”‚
â”‚                                                   â–¼                     â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                                          â”‚ Calibrated  â”‚               â”‚
â”‚                                          â”‚ Probability â”‚               â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æ ¡æ­£æ‰‹æ³•

#### 5.2.1 Platt Scalingï¼ˆãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ï¼‰

```python
# src/utils/calibration.py:178-244

# æ•°å¼: P_calibrated = 1 / (1 + exp(A Ã— logit + B))

class PlattScaling:
    @staticmethod
    def fit(logits, labels, max_iter=100, lr=0.01) -> tuple[float, float]:
        """å‹¾é…é™ä¸‹æ³•ã§ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ A, B ã‚’æœ€é©åŒ–"""
        A, B = 0.0, 0.0
        for _ in range(max_iter):
            # ... å‹¾é…è¨ˆç®— ...
            A -= lr * grad_A
            B -= lr * grad_B
        return A, B

    @staticmethod
    def transform(logit: float, A: float, B: float) -> float:
        z = A * logit + B
        return 1.0 / (1.0 + math.exp(-z))
```

**é©ç”¨å ´é¢**: logit ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã€ç²¾åº¦ãŒé«˜ã„

#### 5.2.2 Temperature Scaling

```python
# src/utils/calibration.py:247-312

# æ•°å¼: P_calibrated = sigmoid(logit / T)

class TemperatureScaling:
    @staticmethod
    def fit(logits, labels, max_iter=50, lr=0.1) -> float:
        """è² ã®å¯¾æ•°å°¤åº¦ã‚’æœ€å°åŒ–ã—ã¦æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ T ã‚’æœ€é©åŒ–"""
        T = 1.0
        for _ in range(max_iter):
            # ... NLL å‹¾é…è¨ˆç®— ...
            T -= lr * grad_T
            T = max(0.1, min(10.0, T))  # ç¯„å›²åˆ¶é™
        return T

    @staticmethod
    def transform(logit: float, T: float) -> float:
        return 1.0 / (1.0 + math.exp(-logit / T))
```

**é©ç”¨å ´é¢**: ã‚·ãƒ³ãƒ—ãƒ«ã§åŠ¹æœçš„ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ‰‹æ³•

### 5.3 è©•ä¾¡æŒ‡æ¨™

| æŒ‡æ¨™ | å®šç¾© | ç†æƒ³å€¤ | ç”¨é€” |
|------|------|--------|------|
| **Brier Score** | mean((predicted - actual)Â²) | 0.0 | å…¨ä½“çš„ãªæ ¡æ­£å“è³ª |
| **ECE** | Î£(\|B_m\| / n Ã— \|accuracy(B_m) - confidence(B_m)\|) | 0.0 | ãƒ“ãƒ³åˆ¥ã®æ ¡æ­£èª¤å·® |

```python
# Brier Scoreï¼ˆsrc/utils/calibration.py:320-342ï¼‰
def brier_score(predictions, labels):
    return sum((p - l)**2 for p, l in zip(predictions, labels)) / len(predictions)

# ECEï¼ˆsrc/utils/calibration.py:345-406ï¼‰
def expected_calibration_error(predictions, labels, n_bins=10):
    # 10ãƒ“ãƒ³ã«åˆ†å‰²ã—ã¦å„ãƒ“ãƒ³ã® |accuracy - confidence| ã‚’è¨ˆç®—
    ...
```

### 5.4 åŠ£åŒ–æ¤œçŸ¥ã¨ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

```python
# src/utils/calibration.py:414-700

class CalibrationHistory:
    DEGRADATION_THRESHOLD = 0.05  # 5% Brier æ‚ªåŒ–ã§ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
    DEFAULT_MAX_HISTORY = 10      # ã‚½ãƒ¼ã‚¹ã”ã¨ã«æœ€å¤§10ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¿æŒ

    def check_degradation(self, new_params, old_params):
        if new_params.brier_after > old_params.brier_after * 1.05:
            self.rollback(source, reason="degradation_detected")
```

**ä¿å­˜å…ˆ**:
- `data/calibration_params.json`: ç¾åœ¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- `data/calibration_history.json`: ãƒãƒ¼ã‚¸ãƒ§ãƒ³å±¥æ­´
- `data/calibration_samples.json`: ä¿ç•™ä¸­ã‚µãƒ³ãƒ—ãƒ«
- `data/calibration_rollback_log.json`: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨˜éŒ²

### 5.5 å†æ ¡æ­£ãƒˆãƒªã‚¬ãƒ¼

| æ¡ä»¶ | é–¾å€¤ | å®Ÿè£… |
|------|------|------|
| ã‚µãƒ³ãƒ—ãƒ«è“„ç© | 10ä»¶ä»¥ä¸Š | `RECALIBRATION_THRESHOLD = 10`ï¼ˆâ€»ã‚µãƒ³ãƒ—ãƒ«è“„ç©ã®â€œè‡ªå‹•é…ç·šâ€ã¯åˆ¥é€”å¿…è¦ï¼‰ |
| åŠ£åŒ–æ¤œçŸ¥ | Brier 5%æ‚ªåŒ– | è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ |

**é‡è¦ï¼ˆç¾çŠ¶ã®äº‹å®Ÿï¼‰**:
- æ ¡æ­£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ`src/utils/calibration.py`ï¼‰ã¯å­˜åœ¨ã™ã‚‹ãŒã€NLIæ¨è«–â†’`edges.nli_confidence` ã¸ã®é©ç”¨ã¯æœªé…ç·šã€‚
- MCPã® `calibration_metrics` ã¯ **get_stats / get_evaluations** ã«é™å®šã•ã‚Œã‚‹ï¼ˆè©•ä¾¡/å­¦ç¿’ã®å®Ÿè¡Œã¯MCPçµŒç”±ã§ã¯è¡Œã‚ãªã„è¨­è¨ˆï¼‰ã€‚
- `calibration_evaluations` ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã™ã‚‹ãŒã€ç¾çŠ¶ã‚³ãƒ¼ãƒ‰ã§ã¯ä¸»ã«å‚ç…§ï¼ˆSELECTï¼‰ç”¨é€”ã§ã€è©•ä¾¡çµæœã®æ°¸ç¶šåŒ–ï¼ˆINSERTï¼‰ã¯æœªæ•´å‚™ã®å¯èƒ½æ€§ãŒé«˜ã„ã€‚
- æ ¡æ­£è‡ªä½“ã‚’è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹æƒ³å®šã¯ä¸€åˆ‡ãªã„ã€‚

---

## 6. é–¢é€£ ADR ã®è¦ç´„

### 6.1 ADR-0005: Evidence Graph Structure

| é …ç›® | æ±ºå®šäº‹é … |
|------|----------|
| **ã‚°ãƒ©ãƒ•æ§‹é€ ** | Claim ã‚’ãƒ«ãƒ¼ãƒˆã¨ã™ã‚‹æœ‰å‘ã‚°ãƒ©ãƒ• |
| **Confidence è¨ˆç®—** | ãƒ™ã‚¤ã‚ºæ›´æ–°ï¼ˆBeta åˆ†å¸ƒï¼‰ |
| **Domain Category** | **å‚ç…§æƒ…å ±ã®ã¿**ã€Confidence è¨ˆç®—ã«ã¯ä½¿ç”¨ã—ãªã„ |
| **ã‚¹ã‚³ãƒ¼ãƒ—åˆ†é›¢** | Claims ã¯ task-scopedã€Pages/Fragments ã¯ global |
| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | âœ… å®Ÿè£…æ¸ˆã¿ï¼ˆãŸã ã— â€œæ˜ç¤ºçš„provenance edgeâ€ ç­‰ã¯Open Issueï¼‰ |

### 6.2 ADR-0011: LoRA Fine-tuning Strategy

| é …ç›® | æ±ºå®šäº‹é … |
|------|----------|
| **æ‰‹æ³•** | LoRAï¼ˆLow-Rank Adaptationï¼‰ |
| **å¯¾è±¡ãƒ¢ãƒ‡ãƒ«** | DeBERTa-v3 (NLI) |
| **MCP ãƒ„ãƒ¼ãƒ«åŒ–** | âŒ å´ä¸‹ï¼ˆGPU ç«¶åˆã€é•·æ™‚é–“å‡¦ç†ï¼‰ |
| **é‹ç”¨æ–¹å¼** | ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ™ãƒ¼ã‚¹ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒãƒƒãƒï¼‰ |
| **è¨“ç·´ãƒˆãƒªã‚¬ãƒ¼** | 100+ã‚µãƒ³ãƒ—ãƒ«è“„ç©ã€10%+èª¤åˆ†é¡ç‡ |
| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | ğŸ“ è¨ˆç”»ä¸­ï¼ˆPhase Tï¼‰ |

### 6.3 ADR-0012: Feedback Tool Design

| é …ç›® | æ±ºå®šäº‹é … |
|------|----------|
| **æ§‹é€ ** | 3ãƒ¬ãƒ™ãƒ« Ã— 6ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
| **Domain** | `domain_block`, `domain_unblock`, `domain_clear_override` |
| **Claim** | `claim_reject`, `claim_restore` |
| **Edge** | `edge_correct` â†’ **NLI è¨“ç·´ãƒ‡ãƒ¼ã‚¿è“„ç©** |
| **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£** | TLD ãƒ¬ãƒ™ãƒ«ãƒ–ãƒ­ãƒƒã‚¯ç¦æ­¢ |
| **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹** | âœ… å®Ÿè£…æ¸ˆã¿ |

---

## 7. æ±ºå®šäº‹é … vs æœªæ±ºå®šäº‹é …

### 7.1 âœ… æ±ºå®šæ¸ˆã¿ãƒ»å®Ÿè£…æ¸ˆã¿

| é …ç›® | è©³ç´° | å‚ç…§ |
|------|------|------|
| Evidence Graph æ§‹é€  | NetworkX + SQLite | ADR-0005 |
| ãƒ™ã‚¤ã‚º Confidence è¨ˆç®— | Beta åˆ†å¸ƒæ›´æ–° | evidence_graph.py:344-474 |
| NLI ãƒ¢ãƒ‡ãƒ« | Transformers sequence classifierï¼ˆDeBERTaç³»ï¼‰ | ADR-0004 |
| æ ¡æ­£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | Platt/Temperature Scaling | calibration.pyï¼ˆâ€»é©ç”¨é…ç·šã¯åˆ¥ï¼‰ |
| ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ„ãƒ¼ãƒ« | 3ãƒ¬ãƒ™ãƒ«6ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ | ADR-0012 |
| nli_corrections ãƒ†ãƒ¼ãƒ–ãƒ« | LoRA è¨“ç·´ãƒ‡ãƒ¼ã‚¿è“„ç© | schema.sql |
| Domain Category éä½¿ç”¨ | Confidence è¨ˆç®—ã«å½±éŸ¿ã—ãªã„ | ADR-0005 |

### 7.2 âš ï¸ æœªæ±ºå®šãƒ»è­°è«–ä¸­

| é …ç›® | ã‚ªãƒ—ã‚·ãƒ§ãƒ³ | æ¨å¥¨ | å‚ç…§ |
|------|-----------|------|------|
| **llm-confidence ã®æ‰±ã„** | ~~A: å‰Šé™¤, B: ãƒ•ã‚£ãƒ«ã‚¿, C: å¼±ã„äº‹å‰åˆ†å¸ƒ~~, **D: æŠ½å‡ºå“è³ªã‚¹ã‚³ã‚¢ã¨ã—ã¦ã®ã¿æ´»ç”¨** | **D ã§ç¢ºå®š** | Â§8.5 |

### 7.3 âŒ æœªå®Ÿè£…ãƒ»å°†æ¥è¨ˆç”»

| é …ç›® | ãƒ•ã‚§ãƒ¼ã‚º | å‰ææ¡ä»¶ |
|------|----------|----------|
| LoRA è¨“ç·´ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | Phase T | PEFT ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ |
| ã‚¢ãƒ€ãƒ—ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† | Phase T | è¨“ç·´ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Œæˆ |
| ã‚·ãƒ£ãƒ‰ã‚¦è©•ä¾¡ | Phase T | 100+ã‚µãƒ³ãƒ—ãƒ«è“„ç© |

---

## 8. llm-confidence ã®æ‰±ã„ï¼ˆææ¡ˆï¼‰

### 8.1 ç¾çŠ¶ã®å•é¡Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å•é¡Œ                                                                    â”‚
â”‚  â”œâ”€â”€ LLM ãŒå‡ºã™ confidence ãŒã€ŒæŠ½å‡ºå“è³ªã€ãªã®ã‹ã€ŒçœŸå½ã€ãªã®ã‹ãŒæ›–æ˜§       â”‚
â”‚  â”œâ”€â”€ claim_confidence ã¯ä¿æŒã•ã‚Œã‚‹ãŒã€çœŸå½æ¨å®šï¼ˆbayesian-confidenceï¼‰ã®å…¥åŠ›ã«ã¯ä½¿ã‚ãªã„ â”‚
â”‚  â”œâ”€â”€ ç”¨èªã®æ··ä¹±ã‚’æ‹›ã                                                    â”‚
â”‚  â””â”€â”€ å‡¦ç†ãƒªã‚½ãƒ¼ã‚¹ã®ç„¡é§„                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ¯”è¼ƒ

#### Option A: å‰Šé™¤ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ï¼‰

```python
# extract_claims.j2 ã‹ã‚‰ confidence ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
{"claim": "ä¸»å¼µã®å†…å®¹", "type": "fact|opinion|prediction"}

# claims.claim_confidence ã¯ deprecated
```

| Pros | Cons |
|------|------|
| ã‚·ãƒ³ãƒ—ãƒ« | å°†æ¥ã®æ‹¡å¼µæ€§ã‚’å¤±ã† |
| èª¤è§£ãªã— | æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ´»ç”¨ä¸å¯ |

#### Option B: ãƒ•ã‚£ãƒ«ã‚¿ç”¨ï¼ˆå“è³ªã‚²ãƒ¼ãƒˆï¼‰

```python
# ä½ confidence æŠ½å‡ºã¯ç ´æ£„
if claim.get("confidence", 0.5) < 0.3:
    continue  # æŠ½å‡ºå“è³ªãŒä½ã„
```

| Pros | Cons |
|------|------|
| æŠ½å‡ºå“è³ªå‘ä¸Š | LLM confidence ã®æ ¡æ­£ãŒå›°é›£ |
| æ˜ç¢ºãªé–¾å€¤ | é–¾å€¤æ±ºå®šã®æ ¹æ‹ ãŒå¼±ã„ |

#### Option C: å¼±ã„äº‹å‰åˆ†å¸ƒï¼ˆæ¡ä»¶ä»˜ãï¼‰

```python
# evidence_graph.py:calculate_claim_confidence()

def calculate_claim_confidence(
    self,
    claim_id: str,
    use_llm_prior: bool = True,
) -> dict[str, Any]:
    evidence = self.get_all_evidence(claim_id)

    # NEW: llm-confidence ã‚’å¼±ã„äº‹å‰åˆ†å¸ƒã¨ã—ã¦ä½¿ç”¨
    if use_llm_prior:
        llm_conf = self._get_claim_llm_confidence(claim_id)
        prior_strength = 0.5  # å¼±ã„ã‚¦ã‚§ã‚¤ãƒˆ
        alpha = 1.0 + llm_conf * prior_strength
        beta = 1.0 + (1 - llm_conf) * prior_strength
    else:
        alpha = 1.0  # å…ƒã®ç„¡æƒ…å ±äº‹å‰åˆ†å¸ƒ
        beta = 1.0

    # ... rest unchanged ...
```

| Pros | Cons |
|------|------|
| æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’æ´»ç”¨ | è¤‡é›‘ã•å¢—åŠ  |
| NLI è¨¼æ‹ ãŒãªã„å ´åˆã®ãƒ’ãƒ³ãƒˆ | æ ¡æ­£ãªã—ã§ã‚‚å½±éŸ¿ã¯è»½å¾® |
| NLI è¨¼æ‹ ãŒå¢—ãˆã‚Œã° wash out | |
| å¾Œæ–¹äº’æ›æ€§ã‚ã‚Š | |

### 8.3 å½±éŸ¿åˆ†æï¼ˆOption Cï¼‰

| çŠ¶æ³ | ç¾åœ¨ | Option C å¾Œ | å¤‰åŒ– |
|------|------|-------------|------|
| NLI è¨¼æ‹ ãªã—ã€llm-conf=0.9 | 0.50 | ~0.55 | +0.05 |
| NLI è¨¼æ‹ ãªã—ã€llm-conf=0.3 | 0.50 | ~0.45 | -0.05 |
| NLI è¨¼æ‹ 1ä»¶ï¼ˆsupports, 0.8ï¼‰ | ~0.64 | ~0.65 | +0.01 |
| NLI è¨¼æ‹ 3ä»¶ï¼ˆsupportsï¼‰ | ~0.80 | ~0.80 | â‰ˆ0 |

**çµè«–**: prior_strength=0.5 ã§ã¯ã€NLI è¨¼æ‹ ãŒ 1-2 ä»¶ã§ prior ã®å½±éŸ¿ã¯æ¶ˆãˆã‚‹ã€‚

### 8.4 Option D: â€œæŠ½å‡ºå“è³ªâ€ã¨ã—ã¦ã®ã¿ä½¿ã†ï¼ˆæ¨å¥¨ï¼‰

**è¦ç‚¹**: `llm-confidence` ã¯ã€Œä¸»å¼µã®çœŸå½ã€ã§ã¯ãªãã€ŒæŠ½å‡ºã®è‡ªå·±è©•ä¾¡ã€ã¨ã—ã¦è§£é‡ˆã—ã€çœŸå½æ¨å®šï¼ˆbayesian-confidenceï¼‰ã®äº‹å‰åˆ†å¸ƒã«ã¯æ··ãœãªã„ã€‚
ç”¨é€”ã‚’é™å®šã—ã¦ã€æ„å‘³è«–ã®æ··ç·šã¨â€œè¨¼æ‹ ã‚¼ãƒ­æ™‚ã®è¦‹ã‹ã‘ã®ç¢ºä¿¡â€ã‚’é¿ã‘ã‚‹ã€‚

- **ç”¨é€”ä¾‹**:
  - ä½ `llm-confidence` ã® claim ã‚’ã€Œè¦å†ç¢ºèªã€ã€Œå„ªå…ˆåº¦ä½ã€ã¨ã—ã¦ææ–™æ•´å½¢ãƒ»UIã§æ‰±ã†
  - ï¼ˆå°†æ¥ï¼‰ä½ `llm-confidence` ã‚’å†æŠ½å‡º/äººæ‰‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å„ªå…ˆåº¦ã«ä½¿ã†
  - `edges.nli_confidence`ï¼ˆè¨¼æ‹ ã®é‡ã¿ï¼‰ã‚„ bayesian-confidence ã«ã¯æ··ãœãªã„

| Pros | Cons |
|------|------|
| çœŸå½æ¨å®šã®æ„å‘³è«–ã‚’å£Šã—ã«ãã„ï¼ˆå­¦è¡“çš„ã«ã‚‚èª¬æ˜ã—ã‚„ã™ã„ï¼‰ | â€œè¨¼æ‹ ã‚¼ãƒ­æ™‚ã®ãƒ’ãƒ³ãƒˆâ€ã«ã¯ãªã‚‰ãªã„ |
| æ ¡æ­£ãƒ‡ãƒ¼ã‚¿ç„¡ã—ã§ã‚‚é‹ç”¨ã§ãã‚‹ | æŠ½å‡ºå“è³ªã®è©•ä¾¡è¨­è¨ˆã¯åˆ¥é€”å¿…è¦ |

### 8.5 çµè«–ï¼ˆç¢ºå®šï¼‰

**ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åã®çµ±ä¸€å¾Œã€Option D ã‚’æ¡ç”¨ã™ã‚‹ã€‚**

- `llm-confidence` ã¯ã€ŒæŠ½å‡ºå“è³ªã‚¹ã‚³ã‚¢ã€ã¨ã—ã¦ã®ã¿æ´»ç”¨ã—ã€çœŸå½æ¨å®šï¼ˆbayesian-confidenceï¼‰ã«ã¯æ··ãœãªã„
- ç†ç”±:
  - çœŸå½æ¨å®šã®æ„å‘³è«–ã‚’å£Šã—ã«ãã„ï¼ˆå­¦è¡“çš„ã«ã‚‚èª¬æ˜ã—ã‚„ã™ã„ï¼‰
  - æ ¡æ­£ãƒ‡ãƒ¼ã‚¿ç„¡ã—ã§ã‚‚é‹ç”¨ã§ãã‚‹
  - ã€Œè¨¼æ‹ ã‚¼ãƒ­æ™‚ã®è¦‹ã‹ã‘ã®ç¢ºä¿¡ã€ã¨ã„ã†èª¤è§£ã‚’æ‹›ããƒªã‚¹ã‚¯ã‚’å›é¿

---

## 9. å­¦è¡“çš„ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã®æ¯”è¼ƒ

### 9.1 Confidence Calibrationï¼ˆç¢ºä¿¡åº¦æ ¡æ­£ï¼‰

| æ‰‹æ³• | æ¦‚è¦ | Lyra ã§ã®çŠ¶æ³ |
|------|------|---------------|
| **Platt Scaling** | ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã«ã‚ˆã‚‹æ ¡æ­£ | âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè£…æ¸ˆã¿ï¼ˆé©ç”¨é…ç·šã¯åˆ¥é€”ï¼‰ |
| **Temperature Scaling** | å˜ä¸€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° | âœ… ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè£…æ¸ˆã¿ï¼ˆé©ç”¨é…ç·šã¯åˆ¥é€”ï¼‰ |
| **Isotonic Regression** | éãƒ‘ãƒ©ãƒ¡ãƒˆãƒªãƒƒã‚¯æ ¡æ­£ | âŒ æœªå®Ÿè£… |
| **Histogram Binning** | ãƒ“ãƒ³åˆ¥æ ¡æ­£ | âŒ æœªå®Ÿè£… |
| **Beta Calibration** | Beta åˆ†å¸ƒãƒ™ãƒ¼ã‚¹ | âŒ æœªå®Ÿè£… |

**æ³¨æ„**: â€œå­¦è¡“çš„ãƒ™ã‚¹ãƒˆâ€ã¯ã‚¿ã‚¹ã‚¯ãƒ»åˆ¶ç´„ä¾å­˜ã§ã‚ã‚Šã€æœ¬ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã§ã¯
ã€Œæ•™å¸«ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ–¹ï¼ˆãƒã‚¤ã‚¢ã‚¹ï¼‰ã€ã€Œ3-class NLIã®æ‰±ã„ã€ã€Œé‹ç”¨ã‚³ã‚¹ãƒˆã€ãŒæ”¯é…çš„ã«ãªã‚‹ã€‚
æœ¬ç¯€ã¯â€œå‚è€ƒæ¯”è¼ƒâ€ã¨ã—ã¦èª­ã‚€ã€‚

**æŠ€è¡“çš„å®Ÿç¾ç­–**:
```python
# è¤‡æ•°æ‰‹æ³•ã®ã‚¢ãƒ³ã‚µãƒ³ãƒ–ãƒ«
calibrated_probs = [
    platt_scaling.transform(logit),
    temperature_scaling.transform(logit),
    isotonic_regression.transform(prob),
]
final_prob = np.mean(calibrated_probs)  # or weighted average
```

### 9.2 Evidence Aggregationï¼ˆè¨¼æ‹ é›†ç´„ï¼‰

| æ‰‹æ³• | æ¦‚è¦ | Lyra ã§ã®çŠ¶æ³ |
|------|------|---------------|
| **Bayesian Updating** | Beta åˆ†å¸ƒã«ã‚ˆã‚‹æ›´æ–° | âœ… æ¡ç”¨ |
| **Dempster-Shafer** | è¨¼æ‹ ç†è«– | âŒ æœªæ¡ç”¨ |
| **Subjective Logic** | ä¸ç¢ºå®Ÿæ€§ãƒ¢ãƒ‡ãƒªãƒ³ã‚° | âŒ æœªæ¡ç”¨ |
| **Weighted Voting** | é‡ã¿ä»˜ã‘æŠ•ç¥¨ | âŒ æœªæ¡ç”¨ |

**è£œè¶³**: Subjective Logic ç­‰ã¯é­…åŠ›çš„ã ãŒã€ç¾çŠ¶ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆsupports/refutes/neutral + é‡ã¿ï¼‰ã§ã¯
Betaæ›´æ–°ãŒèª¬æ˜å®¹æ˜“ã§ã€å®Ÿè£…ãƒ»é‹ç”¨ã®æ•´åˆã‚‚å–ã‚Šã‚„ã™ã„ã€‚

**æŠ€è¡“çš„å®Ÿç¾ç­–**:
```python
# Subjective Logic ã®å°å…¥ï¼ˆå°†æ¥ï¼‰
class SubjectiveOpinion:
    belief: float      # ä¿¡å¿µ
    disbelief: float   # ä¸ä¿¡
    uncertainty: float # ä¸ç¢ºå®Ÿæ€§
    base_rate: float   # åŸºæº–ç‡

    def fuse(self, other: "SubjectiveOpinion") -> "SubjectiveOpinion":
        # Cumulative fusion operator
        ...
```

### 9.3 Source Reliabilityï¼ˆã‚½ãƒ¼ã‚¹ä¿¡é ¼æ€§ï¼‰

| æ‰‹æ³• | æ¦‚è¦ | Lyra ã§ã®çŠ¶æ³ |
|------|------|---------------|
| **Domain-based** | ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¥é‡ã¿ | âŒ Confidence è¨ˆç®—ã«éä½¿ç”¨ï¼ˆADR-0005ï¼‰ |
| **Citation-based** | è¢«å¼•ç”¨æ•° | ğŸ“ ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿æŒ |
| **Temporal Decay** | æ™‚é–“æ¸›è¡° | âŒ æœªå®Ÿè£… |
| **Cross-validation** | ç›¸äº’æ¤œè¨¼ | âŒ æœªå®Ÿè£… |

**æ³¨æ„**: Domain-based weightingã¯ADR-0005ã§åŸå‰‡ä¸æ¡ç”¨ã€‚å°å…¥ã™ã‚‹ãªã‚‰ã€
â€œãƒ‰ãƒ¡ã‚¤ãƒ³â€ã§ã¯ãªãâ€œç ”ç©¶ãƒ‡ã‚¶ã‚¤ãƒ³/æŸ»èª­/è¢«å¼•ç”¨/å†ç¾æ€§â€ç­‰ã®ã€ã‚ˆã‚Šèª¬æ˜å¯èƒ½ãªç‰¹å¾´é‡ã«å¯„ã›ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

**æŠ€è¡“çš„å®Ÿç¾ç­–**:
```python
# æ™‚é–“æ¸›è¡°ã®å°å…¥ï¼ˆå°†æ¥ï¼‰
def apply_temporal_decay(confidence: float, publication_year: int) -> float:
    current_year = 2025
    age = current_year - publication_year
    decay_factor = 0.95 ** age  # 5% annual decay
    return confidence * decay_factor
```

---

## 10. èª²é¡Œã¨æŠ€è¡“çš„è§£æ±ºç­–

### 10.1 ç¾åœ¨ã®èª²é¡Œ

| èª²é¡Œ | è©³ç´° | å„ªå…ˆåº¦ |
|------|------|--------|
| **ç”¨èªã®æ··ä¹±** | 3ç¨®é¡ã® confidence ãŒæ··åœ¨ | é«˜ |
| **llm-confidence ã®æ„å‘³è«–** | æŠ½å‡ºå“è³ª/çœŸå½ãŒæ··ç·šã—ã‚„ã™ã„ | ä¸­ |
| **æ ¡æ­£ãƒ•ã‚¡ã‚¤ãƒ«å** | `calibration.py` ãŒ NLI å°‚ç”¨ã«è¦‹ãˆãªã„ | ä¸­ |
| **LoRA æœªå®Ÿè£…** | ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒæ´»ç”¨ã•ã‚Œã¦ã„ãªã„ | ä½ï¼ˆå°†æ¥ï¼‰ |
| **æ ¡æ­£ã®é…ç·šä¸è¶³** | NLIæ¨è«–â†’edgesã¸ã®æ ¡æ­£é©ç”¨ã€è©•ä¾¡çµæœã®æ°¸ç¶šåŒ–ãŒæœªæ•´å‚™ | é«˜ |

### 10.2 æŠ€è¡“çš„è§£æ±ºç­–

#### èª²é¡Œ1: ç”¨èªã®æ··ä¹±

**è§£æ±ºç­–**: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•´å‚™ + ã‚³ãƒ¼ãƒ‰å†…ã‚³ãƒ¡ãƒ³ãƒˆçµ±ä¸€

```python
# Before
confidence = ...  # ä½•ã® confidence?

# After
nli_confidence = ...      # NLI ãƒ¢ãƒ‡ãƒ«ã®å‡ºåŠ›
bayesian_confidence = ... # ãƒ™ã‚¤ã‚ºæ›´æ–°å¾Œã®ä¿¡é ¼åº¦
```

#### èª²é¡Œ2: llm-confidence ã®æ„å‘³è«–ï¼ˆæŠ½å‡ºå“è³ª vs çœŸå½ï¼‰

**è§£æ±ºç­–**: `llm-confidence` ã¯ã€ŒæŠ½å‡ºå“è³ªã®è‡ªå·±è©•ä¾¡ã€ã¨ã—ã¦ã®ã¿åˆ©ç”¨ã™ã‚‹ï¼ˆçœŸå½æ¨å®šã®å…¥åŠ›ã«ã¯ã—ãªã„ï¼‰ã€‚

#### èª²é¡Œ3: æ ¡æ­£ãƒ•ã‚¡ã‚¤ãƒ«å

**è§£æ±ºç­–**: ãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒãƒ¼ãƒ  + actionåã§ã®æ˜ç¢ºåŒ–

| ç¾åœ¨ | ææ¡ˆ |
|------|------|
| `src/utils/calibration.py` | `src/utils/nli_calibration.py` |

**MCPãƒ„ãƒ¼ãƒ«åã¯å¤‰æ›´ã—ãªã„**ã€‚actionåã§ `nli_*` prefix ã‚’ä»˜ã‘ã¦æ˜ç¢ºåŒ–ã™ã‚‹ï¼ˆä¾‹: `get_stats` â†’ `nli_get_stats`ï¼‰ã€‚

#### èª²é¡Œ4: LoRA æœªå®Ÿè£…

**è§£æ±ºç­–**: Phase T ã§ã®å®Ÿè£…

```bash
# è¨“ç·´ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå°†æ¥ï¼‰
python scripts/train_lora.py \
    --db data/lyra.db \
    --min-samples 100 \
    --output adapters/nli-lora-v1

# ã‚¢ãƒ€ãƒ—ã‚¿é©ç”¨
curl -X POST http://localhost:8001/nli/adapter/load \
    -d '{"adapter_path": "adapters/nli-lora-v1"}'
```

---

## 11. å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 0: E2Eãƒ‡ãƒãƒƒã‚°ï¼ˆç¾åœ¨é€²è¡Œä¸­ï¼‰

**å‰æ**: ä»¥ä¸‹ã® Phase 1 ä»¥é™ã¯ã€E2Eãƒ‡ãƒãƒƒã‚°å®Œäº†å¾Œã«ç€æ‰‹ã™ã‚‹ã€‚

| ã‚¿ã‚¹ã‚¯ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | å‚™è€ƒ |
|--------|:----------:|------|
| E2Eãƒ‡ãƒãƒƒã‚°å®Œäº† | ğŸ”„ é€²è¡Œä¸­ | æ ¡æ­£æœªé©ç”¨ã®å½±éŸ¿ã‚’è€ƒæ…®ï¼ˆD.7.6å‚ç…§ï¼‰ |

### Phase 1: ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ä¿®æ­£ï¼ˆE2Eãƒ‡ãƒãƒƒã‚°å¾Œï¼‰

**å„ªå…ˆåº¦ P0-P1**: ã‚·ã‚¹ãƒ†ãƒ ã®æ­£ç¢ºæ€§ã«ç›´æ¥å½±éŸ¿ã™ã‚‹ä¿®æ­£

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | ãƒ•ã‚¡ã‚¤ãƒ« | è©³ç´° | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|:------:|--------|----------|------|:----------:|
| **P0** | NLIæ¨è«–ã¸ã®æ ¡æ­£é©ç”¨ | `src/filter/nli.py` | `calibrate()` ã‚’ `predict()` ã«é…ç·š | âŒ |
| **P0** | batch_predict ã¸ã®æ ¡æ­£é©ç”¨ | `src/filter/nli.py` | åŒä¸Šï¼ˆãƒãƒƒãƒå‡¦ç†ç”¨ï¼‰ | âŒ |
| **P1** | MCPã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆä¿®æ­£ | `src/mcp/server.py` | outputSchema ã‚’å®Ÿè£…ã«åˆã‚ã›ã‚‹ï¼ˆD.2.2ï¼‰ | âŒ |

### Phase 2: MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ”¯æ´ï¼ˆP0å®Œäº†å¾Œï¼‰

**å„ªå…ˆåº¦ P2-P3**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ„æ€æ±ºå®šã‚’æ”¯æ´ã™ã‚‹æ”¹å–„

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | ãƒ•ã‚¡ã‚¤ãƒ« | è©³ç´° | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|:------:|--------|----------|------|:----------:|
| **P2** | llm-confidence ã®MCPéœ²å‡º | `src/research/materials.py` | Â§3.4.2 ã®åˆ†é›¢å®Ÿè£… | âŒ |
| **P2** | uncertainty/controversy ã‚¬ã‚¤ãƒ‰è¿½åŠ  | `config/mcp/get_materials.json` | D.5 å‚ç…§ | âŒ |
| **P3** | è©•ä¾¡çµæœã®æ°¸ç¶šåŒ– | `src/utils/calibration.py` | `save_evaluation_result()` è¿½åŠ  | âŒ |

### Phase 3: ã‚³ãƒ¼ãƒ‰å“è³ªï¼ˆå…¨ã¦å®Œäº†å¾Œï¼‰

**å„ªå…ˆåº¦ P4**: å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ã®å‘ä¸Š

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | å¤‰æ›´å‰ | å¤‰æ›´å¾Œ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|:------:|--------|--------|--------|:----------:|
| **P4** | ãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒãƒ¼ãƒ  | `calibration.py` | `nli_calibration.py` | ğŸ“ |
| **P4** | import æ›´æ–° | å…¨å‚ç…§ç®‡æ‰€ | - | ğŸ“ |

### Phase D: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆä¸¦è¡Œä½œæ¥­å¯ï¼‰

| ã‚¿ã‚¹ã‚¯ | ãƒ•ã‚¡ã‚¤ãƒ« | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|--------|----------|:----------:|
| æœ¬è¨­è¨ˆæ–‡æ›¸ã®ç¢ºå®š | `docs/confidence-calibration-design.md` | âœ… |
| ADR-0011 ã¸ã®å‚ç…§è¿½åŠ  | `docs/adr/0011-lora-fine-tuning.md` | ğŸ“ |

### Phase T: LoRA å®Ÿè£…ï¼ˆå°†æ¥ï¼‰

| ã‚¿ã‚¹ã‚¯ | å†…å®¹ | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ |
|--------|------|:----------:|
| R.1.x | PEFT/LoRA ãƒ©ã‚¤ãƒ–ãƒ©ãƒªçµ±åˆ | âŒ |
| R.2.x | è¨“ç·´ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ | âŒ |
| R.3.x | ã‚¢ãƒ€ãƒ—ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç† | âŒ |
| R.4.x | ãƒ†ã‚¹ãƒˆã¨æ¤œè¨¼ | âŒ |

---

## 12. é–¾å€¤ä¸€è¦§

| é–¾å€¤ | å€¤ | å ´æ‰€ | ç”¨é€” |
|------|-----|------|------|
| é«˜ Confidence | â‰¥ 0.7 | report/generator.py | ãƒ¬ãƒãƒ¼ãƒˆå†…åˆ†é¡ |
| åè«–æ¤œå‡º | > 0.7 | filter/nli.py | çŸ›ç›¾æ¤œå‡º |
| OCR è¡Œä¿¡é ¼åº¦ | > 0.5 | extractor/content.py | OCRã®ä½ä¿¡é ¼è¡Œã‚’é™¤å¤– |
| æ ¡æ­£åŠ£åŒ– | 0.05 | utils/calibration.py | ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒˆãƒªã‚¬ãƒ¼ |
| å†æ ¡æ­£ | â‰¥ 10 samples | utils/calibration.py | å†æ ¡æ­£ãƒˆãƒªã‚¬ãƒ¼ |
| LoRA è¨“ç·´ | â‰¥ 100 samples | ADR-0011 | è¨“ç·´é–‹å§‹æ¡ä»¶ |

---

## 13. ç”¨èªãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å‘½åä½“ç³»ï¼ˆç¾çŠ¶æ£šå¸ã—ã¨ææ¡ˆï¼‰

### 13.1 å•é¡Œæ„è­˜

ç¾çŠ¶ã¯ `confidence` / `score` ã¨ã„ã†èªãŒ **è¤‡æ•°ã®ãƒ¢ãƒ‡ãƒ«ãƒ»è¤‡æ•°ã®å¯¾è±¡ï¼ˆclaim/edge/fragment/pageï¼‰** ã§ä½¿ã„å›ã•ã‚Œã¦ãŠã‚Šã€
MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã€Œã©ã®ãƒ¢ãƒ‡ãƒ«ã®ä½•ã®ã‚¹ã‚³ã‚¢ã‹ã€ã‚’èª¤è§£ã—ã‚„ã™ã„ã€‚

ç›®çš„ã¯ã€MCPãƒ„ãƒ¼ãƒ«ãƒ»ã‚³ãƒ¼ãƒ‰ãƒ»DBã‚¹ã‚­ãƒ¼ãƒã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒ **prefix/suffix ã§æ©Ÿæ¢°çš„ã«è­˜åˆ¥ã§ãã‚‹**çŠ¶æ…‹ã«ã™ã‚‹ã“ã¨ã€‚

### 13.2 ææ¡ˆï¼šå‘½åãƒ«ãƒ¼ãƒ«ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸Šã®æ­£è¦åï¼‰

**åŸå‰‡**: `"{producer}.{object}.{metric}[.{qualifier}]"` ã‚’æ­£è¦åï¼ˆcanonicalï¼‰ã¨ã—ã€å®Ÿè£…ä¸Šã®è­˜åˆ¥å­ã¯ snake_case ã§è¡¨ç¾ã™ã‚‹ã€‚

- **producerï¼ˆç”Ÿæˆå…ƒï¼‰**: `rank | llm | nli | bayes | calib | meta`
- **objectï¼ˆå¯¾è±¡ï¼‰**: `fragment | claim | edge | page | citation_candidate`
- **metricï¼ˆæŒ‡æ¨™ï¼‰**: `score | confidence | uncertainty | controversy | weight | label | prob | logit`
- **qualifierï¼ˆä»»æ„ï¼‰**: `raw | calibrated | final | bm25 | embed | rerank | category | source`

ä¾‹ï¼ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä¸Šã®æ­£è¦åï¼‰:
- `llm.claim.confidence_raw`ï¼ˆæŠ½å‡ºå“è³ªã®è‡ªå·±è©•ä¾¡ï¼‰
- `nli.edge.confidence_raw`ï¼ˆNLIã®å‡ºåŠ›ã‚¹ã‚³ã‚¢ã€ç¾çŠ¶ã¯æœªæ ¡æ­£ï¼‰
- `bayes.claim.confidence` / `bayes.claim.uncertainty` / `bayes.claim.controversy`
- `rank.fragment.score_bm25` / `rank.fragment.score_embed` / `rank.fragment.score_rerank` / `rank.fragment.score_final`

### 13.3 ç¾çŠ¶ã®åå‰ï¼ˆDB / ã‚³ãƒ¼ãƒ‰ / MCPï¼‰ã®å¯¾å¿œè¡¨

| æ­£è¦åï¼ˆææ¡ˆï¼‰ | ç¾çŠ¶ã®ä¸»ãªå®Ÿä½“ | ç¨®åˆ¥ | å‚™è€ƒ |
|---|---|---|---|
| `rank.fragment.score_bm25` | `fragments.bm25_score` / `passage["score_bm25"]` | score | ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ |
| `rank.fragment.score_embed` | `fragments.embed_score` / `passage["score_embed"]` | score | ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ |
| `rank.fragment.score_rerank` | `fragments.rerank_score` / `passage["score_rerank"]` | score | ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨ |
| `rank.fragment.weight_category` | `passage["category_weight"]` / `CATEGORY_WEIGHTS` | weight | rankingèª¿æ•´ã®ã¿ |
| `rank.fragment.score_final` | `passage["final_score"]` | score | rankingæœ€çµ‚ |
| `llm.claim.confidence_raw` | `claims.claim_confidence`ï¼ˆpromptã® `confidence`ï¼‰ | confidence | æŠ½å‡ºå“è³ªï¼ˆçœŸå½ã§ã¯ãªã„ï¼‰ |
| `nli.edge.label` | `edges.nli_label` | label | supports/refutes/neutral |
| `nli.edge.confidence_raw` | `edges.nli_confidence` | confidence | NLIå‡ºåŠ›ã‚¹ã‚³ã‚¢ï¼ˆç¾çŠ¶æœªæ ¡æ­£ï¼‰ |
| `bayes.claim.confidence` | `get_materials.claims[].confidence`ï¼ˆç¾çŠ¶ï¼‰ | confidence | EvidenceGraphé›†ç´„å¾Œ |
| `bayes.claim.uncertainty` | `get_materials.claims[].uncertainty` | uncertainty | Betaäº‹å¾Œã®stddev |
| `bayes.claim.controversy` | `get_materials.claims[].controversy` | controversy | æ”¯æŒ/åè¨¼ã®å¯¾ç«‹åº¦ |
| `meta.claim.source_domain_category` | `_lyra_meta.claims[].source_domain_category` | meta | rankingç”±æ¥ã®å‚ç…§æƒ…å ± |

### 13.4 MCPãƒ„ãƒ¼ãƒ«ã®å‘½åï¼ˆææ¡ˆï¼‰

ãƒ¬ã‚¹ãƒãƒ³ã‚¹å†…ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯ä¸Šè¨˜ã®æ­£è¦åã«æ²¿ã†ï¼ˆã¾ãŸã¯ãã‚Œã‚’æ˜ç¤ºã§ãã‚‹æ§‹é€ ï¼‰ã«å¯„ã›ã‚‹ã€‚MCPãƒ„ãƒ¼ãƒ«åã¯å¤‰ãˆãªã„ãŒã€MCP actionåã¯å¤‰æ›´å¯èƒ½ã¨ã™ã‚‹ã€‚

- `get_materials`
  - ç¾çŠ¶: `claims[].confidence` ãŒ â€œbayesianâ€ ãªã®ã‹ â€œllmãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯â€ ãªã®ã‹æ›–æ˜§ã€‚
  - ææ¡ˆ: `confidence_source` ã¨ `llm_confidence` / `bayesian_confidence` ã‚’ä½µç½®ã—ã¦æ··åŒã‚’é˜²ãï¼ˆÂ§3.4ï¼‰ã€‚
- `calibration_metrics`
  - ç¾çŠ¶: `source` ãŒè‡ªç”±æ–‡å­—åˆ—ã§ã€ä½•ã®ãƒ¢ãƒ‡ãƒ«ã‹ãŒæ›–æ˜§ã«ãªã‚Šå¾—ã‚‹ã€‚
  - ææ¡ˆ: `source` ã¯ `nli` ç­‰ã®å›ºå®šnamespaceã‚’å«ã‚ã‚‹ï¼ˆä¾‹: `nli_judge` ã‚’æ­£è¦åŒ–ã—ã¦ `nli.edge.confidence` ã®ç³»çµ±ã«æƒãˆã‚‹ï¼‰ã€‚

### 13.5 å®Ÿè£…ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆç¢ºå®šï¼‰

**æ®µéšçš„ã«å®Ÿæ–½ã™ã‚‹**:

1. **Phase 1: Split keys ã®è§£æ±º**ï¼ˆäººæ‰‹ç¢ºèªå¿…é ˆï¼‰
   - `confidence` / `type` / `status` ãªã©ã€åŒåã§è¤‡æ•°ã®æ„å‘³ã‚’æŒã¤ã‚­ãƒ¼ã‚’ç‰¹å®š
   - AIãŒæ–‡è„ˆã‚’ç¢ºèªã—ãªãŒã‚‰ã€Œã©ã®æ„å‘³ã‹ã€ã‚’åˆ¤å®šã—ã€ä¿®æ­£ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
   - ä¾‹: `edges.confidence` ã¯ Fragmentâ†’Claim ã§ã¯ `nli_edge_confidence_raw`ã€CITES ã§ã¯å‰Šé™¤ã¾ãŸã¯åˆ¥å

2. **Phase 2: æ©Ÿæ¢°çš„ç½®æ›**ï¼ˆPhase 1 ç¢ºå®šå¾Œï¼‰
   - ä¸€æ„ã«å¯¾å¿œãŒæ±ºã¾ã‚‹ã‚­ãƒ¼ã®å¤‰æ›ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
   - grep/sed ã¾ãŸã¯ AST ãƒ™ãƒ¼ã‚¹ã§ä¸€æ‹¬å¤‰æ›

**å¾Œæ–¹äº’æ›æ€§ã¯ä¸è¦**ï¼ˆç ´å£Šçš„å¤‰æ›´ã¨ã—ã¦å®Ÿæ–½ï¼‰ã€‚E2Eãƒ‡ãƒãƒƒã‚°å®Œäº†å¾Œã«ç€æ‰‹ã™ã‚‹ã€‚

## Appendix: Implementation Gapsï¼ˆADR-0005 é–¢é€£ï¼‰

ä»¥ä¸‹ã¯ ADR-0005 ã§æœ›ã¾ã—ã„ã¨ã•ã‚Œã¦ã„ã‚‹ãŒã€ç¾åœ¨ã®å®Ÿè£…ã§ã¯å®Œå…¨ã«å®Ÿç¾ã•ã‚Œã¦ã„ãªã„é …ç›®ã€‚

### Gap 1: Explicit extraction provenance edge

| é …ç›® | å†…å®¹ |
|------|------|
| **ADR intent** | `EXTRACTED_FROM (Fragment â†’ Page)` ã‚’æ˜ç¤ºçš„ãªã‚°ãƒ©ãƒ•ã‚¨ãƒƒã‚¸ã¨ã—ã¦è¡¨ç¾ã—ã€provenance ãƒ¢ãƒ‡ãƒªãƒ³ã‚°ã‚’çµ±ä¸€ã™ã‚‹ |
| **Current implementation** | Provenance ã¯ `fragments.page_id â†’ pages.id` ã®ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒªãƒ³ã‚¯ã§æš—é»™çš„ã«è¡¨ç¾ã€‚`edges` ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯å­˜åœ¨ã—ãªã„ |
| **Impact** | `edges` ãƒ†ãƒ¼ãƒ–ãƒ«ã ã‘ã§ provenance ã‚’è¾¿ã‚Œãªã„ï¼ˆãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã® JOIN ãŒå¿…è¦ï¼‰ |

### Gap 2: Fragment-level citation edges

| é …ç›® | å†…å®¹ |
|------|------|
| **ADR intent** | `CITES (Fragment â†’ Fragment)` ã§æŠœç²‹ãƒ¬ãƒ™ãƒ«ã®ç´°ç²’åº¦ citation/provenance ã‚’è¡¨ç¾ |
| **Current implementation** | `CITES` ã¯ `Page â†’ Page` ã¨ã—ã¦ä¿å­˜ï¼ˆå­¦è¡“ API ã¾ãŸã¯ HTML å¼•ç”¨æ¤œå‡ºç”±æ¥ï¼‰ |
| **Impact** | å¼•ç”¨ãƒã‚§ãƒ¼ãƒ³ã¯ã‚½ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ã§ã‚ã‚Šã€æŠœç²‹ãƒ¬ãƒ™ãƒ«ã§ã¯ãªã„ã€‚å¤šãã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã§ã¯ååˆ†ã ãŒç²¾åº¦ã¯ä½ã„ |

### Gap 3: Source reliability weighting

| é …ç›® | å†…å®¹ |
|------|------|
| **ADR intent** | ä¿¡é ¼æ€§é …ï¼ˆä¾‹: ã‚½ãƒ¼ã‚¹ä¿¡é ¼ã‚·ã‚°ãƒŠãƒ«ï¼‰ã‚’ confidence é›†ç´„ã«çµ„ã¿è¾¼ã‚€ |
| **Current implementation** | Domain category ã¯è¨­è¨ˆä¸Š confidence è¨ˆç®—ã«ä½¿ç”¨ã—ãªã„ï¼ˆãƒã‚¤ã‚¢ã‚¹å›é¿ï¼‰ã€‚ä»£æ›¿ã®ä¿¡é ¼æ€§ã‚·ã‚°ãƒŠãƒ«ã‚‚ç¾çŠ¶ã§ã¯ä¹—ç®—ã•ã‚Œã¦ã„ãªã„ |
| **Impact** | å…¨ã¦ã® evidence weight ã¯ NLI ã®ã¿ã‹ã‚‰æ¥ã‚‹ã€‚å°†æ¥çš„ã«ã¯ domain ãƒ¬ãƒ™ãƒ«ã®ãƒã‚¤ã‚¢ã‚¹ãªã—ã« evidence-quality ç‰¹å¾´é‡ï¼ˆå¼•ç”¨å“è³ªã€ç ”ç©¶ã‚¿ã‚¤ãƒ—ã€æ–°ã—ã•ãƒ•ãƒ©ã‚°ç­‰ï¼‰ã‚’è¿½åŠ å¯èƒ½ |

---

## Appendix A: ã‚³ãƒ¼ãƒ‰å‚ç…§

| æ¦‚å¿µ | ãƒ•ã‚¡ã‚¤ãƒ« | å‚™è€ƒ |
|------|----------|------|
| NodeType, RelationType / EvidenceGraph | `src/filter/evidence_graph.py` | Graphæ§‹é€ ãƒ»DBãƒ­ãƒ¼ãƒ‰ãƒ»Betaæ›´æ–° |
| calculate_claim_confidence() | `src/filter/evidence_graph.py` | Betaæ›´æ–°ï¼ˆsupports/refutesã®nli_confidenceã‚’åŠ ç®—ï¼‰ |
| add_claim_evidence() | `src/filter/evidence_graph.py` | edgesæ°¸ç¶šåŒ–ï¼ˆnli_confidence/labelå«ã‚€ï¼‰ |
| ClaimConfidenceAssessment | `src/filter/schemas.py` | get_materialsã¨ã®å¢ƒç•Œå¥‘ç´„ |
| Calibrator / Platt / Temperature | `src/utils/calibration.py` | æ ¡æ­£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆãŸã ã—é©ç”¨é…ç·šã¯åˆ¥ï¼‰ |
| NLI judge | `src/filter/nli.py` | local/remote NLIï¼ˆTransformersï¼‰ |
| Ranking | `src/filter/ranking.py` | DomainCategoryé‡ã¿ã¯rankingã®ã¿ |
| DB schema | `src/storage/schema.sql` | pages/fragments/claims/edges/nli_corrections ç­‰ |
| llm-confidence ç”Ÿæˆ | `config/prompts/extract_claims.j2` | JSONå‡ºåŠ›ã« confidence ã‚’å«ã‚€ |
| llm-confidence ã‚’ãƒ™ã‚¤ã‚ºå…¥åŠ›ã«ã—ãªã„ | `src/research/executor.py` | NLIã‚’edgesã«ä¿å­˜ã—ã€LLM confidence ã¯å…¥åŠ›ã«ã—ãªã„æ—¨ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã§æ˜ç¤º |

## Appendix B: é–¢é€£ ADR ä¸€è¦§

| ADR | ã‚¿ã‚¤ãƒˆãƒ« | Confidence é–¢é€£åº¦ |
|-----|----------|:----------------:|
| 0004 | Local LLM for Extraction Only | âœ… NLI åˆ†é¡ |
| 0005 | Evidence Graph Structure | âœ… **åŸºç›¤** |
| 0008 | Academic Data Source Strategy | âœ… è¨¼æ‹ åé›† |
| 0011 | LoRA Fine-tuning Strategy | âœ… **NLI æ ¡æ­£** |
| 0012 | Feedback Tool Design | âœ… **è¨“ç·´ãƒ‡ãƒ¼ã‚¿åé›†** |

## Appendix C: ç”¨èªé›†

| ç”¨èª | å®šç¾© |
|------|------|
| **llm-confidence** | LLM ãŒæŠ½å‡ºæ™‚ã«è‡ªå·±å ±å‘Šã™ã‚‹ç¢ºä¿¡åº¦ï¼ˆæŠ½å‡ºå“è³ªã®è‡ªå·±è©•ä¾¡ï¼‰ã€‚çœŸå½æ¨å®šã®å…¥åŠ›ã«ã¯ä½¿ã‚ãªã„ã€‚ |
| **nli-confidence** | NLI ãƒ¢ãƒ‡ãƒ«ãŒè¨¼æ‹ é–¢ä¿‚ï¼ˆsupports/refutes/neutralï¼‰ã‚’åˆ¤å®šã—ãŸã‚¹ã‚³ã‚¢ã€‚ãƒ™ã‚¤ã‚ºæ›´æ–°ã®å…¥åŠ›ï¼ˆè¨¼æ‹ ã®é‡ã¿ï¼‰ã€‚ |
| **bayesian-confidence** | å…¨è¨¼æ‹ ã‚’é›†ç´„ã—ãŸä¸»å¼µã®æœ€çµ‚çš„ãªä¿¡é ¼åº¦ã€‚ |
| **Platt Scaling** | ãƒ­ã‚¸ã‚¹ãƒ†ã‚£ãƒƒã‚¯å›å¸°ã«ã‚ˆã‚‹ç¢ºç‡æ ¡æ­£æ‰‹æ³•ã€‚ |
| **Temperature Scaling** | å˜ä¸€æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«ã‚ˆã‚‹ç¢ºç‡æ ¡æ­£æ‰‹æ³•ã€‚ |
| **Brier Score** | ç¢ºç‡äºˆæ¸¬ã®ç²¾åº¦æŒ‡æ¨™ã€‚0 ãŒç†æƒ³ã€‚ |
| **ECE** | Expected Calibration Errorã€‚æ ¡æ­£èª¤å·®ã®æŒ‡æ¨™ã€‚ |
| **LoRA** | Low-Rank Adaptationã€‚ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŠ¹ç‡çš„ãªãƒ•ã‚¡ã‚¤ãƒ³ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°æ‰‹æ³•ã€‚ |
| **Beta åˆ†å¸ƒ** | ç¢ºç‡ã®ç¢ºç‡åˆ†å¸ƒã€‚ãƒ™ã‚¤ã‚ºæ›´æ–°ã§ä½¿ç”¨ã€‚ |
| **Evidence Graph** | ä¸»å¼µã¨è¨¼æ‹ ã®é–¢ä¿‚ã‚’è¡¨ã™æœ‰å‘ã‚°ãƒ©ãƒ•ã€‚ |

## Appendix D: MCP Schema Alignment Reviewï¼ˆ2025-12-29ï¼‰

### D.1 ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¦‚è¦

MCPãƒ„ãƒ¼ãƒ«ã®Action ã‚¹ã‚­ãƒ¼ãƒã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã€ä»¥ä¸‹ã®è¦³ç‚¹ã§æ¤œè¨¼ã—ãŸï¼š
1. **ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã¨ã®æ­£ç¢ºæ€§**: server.py outputSchema / get_materials.json / å®Ÿè£…ã®æ•´åˆæ€§
2. **ADRã¨ã®æˆ¦ç•¥æ€§**: ADR-0012 feedbackãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹

### D.2 ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œã¨ä¿®æ­£

#### D.2.1 CRITICAL: edge_id ã®æ¬ è½ï¼ˆâœ… ä¿®æ­£æ¸ˆã¿ï¼‰

**å•é¡Œ**: `get_materials` ã® `claims[].evidence[]` ã« `edge_id` ãŒè¿”ã•ã‚Œã¦ã„ãªã‹ã£ãŸã€‚

| ç®‡æ‰€ | ä¿®æ­£å‰ | ä¿®æ­£å¾Œ |
|------|--------|--------|
| `evidence_graph.py:add_edge()` | `edge_id` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã— | `edge_id: str \| None = None` è¿½åŠ  |
| `evidence_graph.py:load_from_db()` | DB ã® `edges.id` ã‚’æ¸¡ã•ãªã„ | `edge_id=edge.get("id")` è¿½åŠ  |
| `evidence_graph.py:get_all_evidence()` | `edge_id` ã‚’è¿”ã•ãªã„ | `"edge_id": edge_data.get("edge_id")` è¿½åŠ  |
| `evidence_graph.py:calculate_claim_confidence()` | evidence_list ã« `edge_id` ãªã— | `"edge_id": e.get("edge_id")` è¿½åŠ  |
| `get_materials.json` | `edge_id` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãªã— | ã‚¹ã‚­ãƒ¼ãƒã«è¿½åŠ  |

**ã‚³ãƒŸãƒƒãƒˆ**: `ab1735d fix(mcp): add edge_id to get_materials response for feedback workflow`

**å½±éŸ¿**: ADR-0012 ã® feedback ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆ`get_materials` â†’ `feedback(edge_correct)`ï¼‰ãŒæ­£å¸¸ã«æ©Ÿèƒ½ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸã€‚

```
ä¿®æ­£å‰ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆbrokenï¼‰:
DB (edges.id)
    â†“
load_from_db() â”€â”€â”€ edges.id ã‚’æ¸¡ã—ã¦ã„ãªã„ âŒ
    â†“
add_edge() â”€â”€â”€â”€â”€â”€â”€ æ–°ã—ã„ UUID ã‚’ç”Ÿæˆ âŒ
    â†“
get_all_evidence() â”€ edge_id ã‚’è¿”ã•ãªã„ âŒ
    â†“
calculate_claim_confidence() â”€ evidence_list ã« edge_id ãªã— âŒ
    â†“
get_materials() â†’ MCPãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆedge_id ãªã—ï¼‰

ä¿®æ­£å¾Œã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆworkingï¼‰:
DB (edges.id = "edge_abc123")
    â†“
load_from_db() â”€â”€â”€ edge_id=edge.get("id") âœ…
    â†“
add_edge() â”€â”€â”€â”€â”€â”€â”€ æ—¢å­˜ ID ã‚’ä¿æŒ âœ…
    â†“
get_all_evidence() â”€ edge_id ã‚’è¿”ã™ âœ…
    â†“
calculate_claim_confidence() â”€ evidence_list ã« edge_id å«ã‚€ âœ…
    â†“
get_materials() â†’ MCPãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆedge_id ã‚ã‚Šï¼‰
    â†“
feedback(action=edge_correct, edge_id="edge_abc123") âœ…
```

#### D.2.2 æ®‹å­˜ã™ã‚‹ä¸æ•´åˆ: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®ä¹–é›¢

**ç¾çŠ¶**: server.py ã® `outputSchema` ã¨å®Ÿè£…ï¼ˆevidence_graph.pyï¼‰ãŒä¸€è‡´ã—ã¦ã„ãªã„ã€‚

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | server.py outputSchema (L463-468) | get_materials.json | å®Ÿè£… (evidence_graph.py) |
|-----------|-----------------------------------|-------------------|--------------------------|
| Edge ID | `edge_id` âœ… | `edge_id` âœ… | `edge_id` âœ… |
| NLIä¿¡é ¼åº¦ | `confidence` | `nli_confidence` | `nli_confidence` |
| ç™ºè¡Œå¹´ | `source_year` | `year` | `year` |
| ã‚½ãƒ¼ã‚¹ID | `fragment_id` | `source_id` | `source_id` |
| ã‚½ãƒ¼ã‚¹ç¨®åˆ¥ | ãªã— | `source_type` | `source_type` |
| ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒª | ãªã— | `source_domain_category` | `source_domain_category` |
| DOI | ãªã— | `doi` | `doi` |
| å‡ºç‰ˆå ´æ‰€ | ãªã— | `venue` | `venue` |

**å•é¡Œç‚¹**:
1. `confidence` vs `nli_confidence`: åå‰ãŒç•°ãªã‚‹ï¼ˆå®Ÿè£…ã¯ `nli_confidence` ã§æ­£ç¢ºï¼‰
2. `source_year` vs `year`: åå‰ãŒç•°ãªã‚‹
3. `fragment_id` vs `source_id`: å®Ÿè£…ã¯æ±ç”¨çš„ã ãŒã€MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«ã¯ `fragment_id` ã®æ–¹ãŒç›´æ„Ÿçš„
4. server.py outputSchema ã«è¿½åŠ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆdoi, venueç­‰ï¼‰ãŒãªã„

**æ¨å¥¨å¯¾å¿œ**:
- **Phase 1**: server.py outputSchema ã‚’å®Ÿè£…ã«åˆã‚ã›ã‚‹ï¼ˆÂ§13.5 ã®å‘½åçµ±ä¸€ã¨é€£æºï¼‰
- **ç†ç”±**: å®Ÿè£…ã® `nli_confidence` ã¯æ„å‘³è«–çš„ã«æ­£ç¢ºï¼ˆNLIãƒ¢ãƒ‡ãƒ«ã®ä¿¡é ¼åº¦ï¼‰ã€`source_id/source_type` ã¯ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ã‚½ãƒ¼ã‚¹ãŒ fragment ä»¥å¤–ï¼ˆpageï¼‰ã®å ´åˆã‚‚ã‚«ãƒãƒ¼

### D.3 get_materials ã‚¹ã‚­ãƒ¼ãƒã® evidence é …ç›®ï¼ˆç¾çŠ¶ï¼‰

```json
{
  "evidence": {
    "type": "array",
    "description": "Evidence items with NLI labels and temporal metadata. Use edge_id with feedback(edge_correct) to fix NLI errors.",
    "items": {
      "type": "object",
      "properties": {
        "edge_id": {
          "type": ["string", "null"],
          "description": "Edge ID for feedback(edge_correct). Use this to correct NLI classification errors."
        },
        "relation": {"type": "string", "enum": ["supports", "refutes", "neutral"]},
        "source_id": {"type": ["string", "null"]},
        "source_type": {"type": ["string", "null"]},
        "year": {"type": ["integer", "string", "null"]},
        "nli_confidence": {"type": ["number", "null"]},
        "source_domain_category": {"type": ["string", "null"]},
        "doi": {"type": ["string", "null"]},
        "venue": {"type": ["string", "null"]}
      }
    }
  }
}
```

### D.4 ADR-0012 ã¨ã®æ•´åˆæ€§

| ADR-0012 ã®è¦ä»¶ | å®Ÿè£…çŠ¶æ³ |
|-----------------|----------|
| `edge_correct` ã§ `edge_id` ã‚’ä½¿ç”¨ | âœ… ä¿®æ­£ã«ã‚ˆã‚Šå¯èƒ½ã« |
| `nli_corrections` ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ä¿å­˜ | âœ… æ—¢å­˜å®Ÿè£…ã§å¯¾å¿œ |
| ä¿®æ­£å¾Œã® edge confidence = 1.0 | âœ… feedback_handler.py ã§å®Ÿè£…æ¸ˆã¿ |
| claim confidence ã®å†è¨ˆç®— | âœ… edge æ›´æ–°å¾Œã«è‡ªå‹•åæ˜  |

### D.5 MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ï¼ˆæˆ¦ç•¥æ€§ï¼‰

**ç¾çŠ¶ã®èª²é¡Œ**: Bayesian confidence model ã®é«˜åº¦ãªä½¿ã„æ–¹ãŒã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰èª­ã¿å–ã‚Šã«ãã„ã€‚

**server.py description (L374-377)** ã«ã¯è©³ç´°ãªæ•°å¼ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ãŒã€get_materials.json ã«ã¯åæ˜ ã•ã‚Œã¦ã„ãªã„ã€‚

```
BAYESIAN CONFIDENCE MODEL:
  Î± = 1 + Î£(supports_confidence)
  Î² = 1 + Î£(refutes_confidence)
  confidence = Î± / (Î± + Î²)
  uncertainty = sqrt(Î±Î² / ((Î±+Î²)Â² Ã— (Î±+Î²+1)))
  controversy = 2 Ã— min(Î±-1, Î²-1) / (Î± + Î² - 2)
```

**æ¨å¥¨**: get_materials.json ã® claims é …ç›®ã« `uncertainty` / `controversy` ã®è§£é‡ˆã‚¬ã‚¤ãƒ‰ã‚’è¿½åŠ ï¼š

```json
{
  "uncertainty": {
    "type": "number",
    "description": "Bayesian uncertainty (stddev). High value (>0.2) indicates insufficient evidence - consider queue_searches for more sources."
  },
  "controversy": {
    "type": "number",
    "description": "Degree of conflict between supports/refutes. High value (>0.3) indicates contested claim - investigate both sides."
  }
}
```

### D.6 TODO: æ®‹ä½œæ¥­

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | é–¢é€£ã‚»ã‚¯ã‚·ãƒ§ãƒ³ |
|--------|--------|----------------|
| P1 | server.py outputSchema ã‚’å®Ÿè£…ã«åˆã‚ã›ã‚‹ | Â§13.5 |
| P2 | get_materials.json ã« uncertainty/controversy ã‚¬ã‚¤ãƒ‰è¿½åŠ  | D.5 |
| P3 | Â§3.4.2 ã® `llm_confidence` / `bayesian_confidence` åˆ†é›¢å®Ÿè£… | Â§3.4.2, Â§8.5 |

### D.7 æ ¡æ­£ã®é…ç·šä¸è¶³ï¼ˆCriticalï¼‰

#### D.7.1 å•é¡Œã®æ¦‚è¦

æ ¡æ­£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ`src/utils/calibration.py`ï¼‰ã¯ **å®Œå…¨ã«å®Ÿè£…æ¸ˆã¿** ã ãŒã€NLIæ¨è«–çµŒè·¯ã¸ã®é©ç”¨ãŒ **é…ç·šã•ã‚Œã¦ã„ãªã„**ã€‚

**ç¾çŠ¶ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆBrokenï¼‰**:
```
NLI Model (DeBERTa)
    â†“ predict()
result["score"] (ç”Ÿã® softmax å‡ºåŠ›)
    â†“ ãã®ã¾ã¾ä½¿ç”¨ï¼ˆæ ¡æ­£ãªã—ï¼‰âŒ
edges.nli_confidence (æœªæ ¡æ­£ã®ç”Ÿã‚¹ã‚³ã‚¢)
    â†“
calculate_claim_confidence() (ãƒ™ã‚¤ã‚ºæ›´æ–°)
```

**ã‚ã‚‹ã¹ããƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**:
```
NLI Model (DeBERTa)
    â†“ predict()
result["score"] (ç”Ÿã® softmax å‡ºåŠ›)
    â†“ calibrator.calibrate(prob, "nli_judge")
calibrated_confidence (æ ¡æ­£æ¸ˆã¿) âœ…
    â†“
edges.nli_confidence (æ ¡æ­£æ¸ˆã¿ã‚¹ã‚³ã‚¢)
    â†“
calculate_claim_confidence() (ãƒ™ã‚¤ã‚ºæ›´æ–°)
```

#### D.7.2 å½±éŸ¿ç¯„å›²

| å½±éŸ¿ | è©³ç´° |
|------|------|
| **E2Eãƒ‡ãƒãƒƒã‚°** | æœªæ ¡æ­£ã® NLI ã‚¹ã‚³ã‚¢ãŒãƒ™ã‚¤ã‚ºæ›´æ–°ã«å…¥ã‚‹ãŸã‚ã€claim confidence ãŒéä¿¡/éå°è©•ä¾¡ã•ã‚Œã‚‹å¯èƒ½æ€§ |
| **FeedbackåŠ¹æœ** | `edge_correct` ã§è¨‚æ­£ã—ã¦ã‚‚ã€æ–°è¦ã‚¨ãƒƒã‚¸ã¯æœªæ ¡æ­£ã®ã¾ã¾ä½œæˆã•ã‚Œã‚‹ |
| **æ ¡æ­£ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿** | `data/calibration_params.json` ãŒå­˜åœ¨ã—ã¦ã‚‚é©ç”¨ã•ã‚Œãªã„ |

#### D.7.3 é–¢é€£ã‚³ãƒ¼ãƒ‰ç®‡æ‰€

| ãƒ•ã‚¡ã‚¤ãƒ« | è¡Œ | ç¾çŠ¶ |
|----------|-----|------|
| `src/filter/nli.py:88-91` | `predict()` | `result["score"]` ã‚’ãã®ã¾ã¾è¿”ã™ |
| `src/filter/nli.py:149-152` | `batch_predict()` | åŒä¸Š |
| `src/utils/calibration.py:85-120` | `calibrate()` | å®Ÿè£…æ¸ˆã¿ã ãŒå‘¼ã³å‡ºã—å…ƒãªã— |
| `src/mcp/server.py:1050-1070` | `calibration_metrics` | get_stats/get_evaluations ã®ã¿ |

#### D.7.4 ä¿®æ­£æ¡ˆ

**Step 1: NLIæ¨è«–ã«æ ¡æ­£ã‚’é©ç”¨**

```python
# src/filter/nli.py ã® predict() ã‚’ä¿®æ­£

async def predict(self, premise: str, hypothesis: str) -> dict[str, Any]:
    # ... existing code ...

    # æ ¡æ­£ã‚’é©ç”¨ï¼ˆæ–°è¦è¿½åŠ ï¼‰
    from src.utils.calibration import get_calibrator
    calibrator = get_calibrator()

    raw_confidence = result["score"]
    calibrated_confidence = calibrator.calibrate(
        raw_confidence,
        source="nli_judge",
        logit=None,  # logit ãŒå–å¾—å¯èƒ½ãªã‚‰ä½¿ç”¨
    )

    return {
        "label": label,
        "confidence": calibrated_confidence,      # æ ¡æ­£æ¸ˆã¿ï¼ˆãƒ™ã‚¤ã‚ºæ›´æ–°ç”¨ï¼‰
        "confidence_raw": raw_confidence,         # ç”Ÿã‚¹ã‚³ã‚¢ï¼ˆãƒ‡ãƒãƒƒã‚°/è©•ä¾¡ç”¨ï¼‰
    }
```

**Step 2: edges.nli_confidence ã«æ ¡æ­£æ¸ˆã¿ã‚¹ã‚³ã‚¢ã‚’ä¿å­˜**

`src/filter/evidence_graph.py:add_claim_evidence()` ã¯æ—¢ã« `nli_confidence` ã‚’å—ã‘å–ã‚‹è¨­è¨ˆãªã®ã§ã€Step 1 ã®ä¿®æ­£ã§è‡ªå‹•çš„ã«æ ¡æ­£æ¸ˆã¿ã‚¹ã‚³ã‚¢ãŒä¿å­˜ã•ã‚Œã‚‹ã€‚

**Step 3: è©•ä¾¡çµæœã®æ°¸ç¶šåŒ–**

```python
# src/utils/calibration.py ã«è¿½åŠ 

async def save_evaluation_result(
    source: str,
    result: CalibrationResult,
    calibration_version: int | None = None,
) -> str:
    """è©•ä¾¡çµæœã‚’ calibration_evaluations ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ°¸ç¶šåŒ–"""
    from src.storage.database import get_database
    import uuid

    db = await get_database()
    eval_id = str(uuid.uuid4())
    await db.execute(
        """INSERT INTO calibration_evaluations
           (id, source, brier_score, brier_score_calibrated,
            improvement_ratio, expected_calibration_error,
            samples_evaluated, bins_json, calibration_version, evaluated_at)
           VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))""",
        (eval_id, source, result.brier_score, result.brier_score_calibrated,
         result.improvement_ratio, result.ece,
         result.samples_evaluated, json.dumps(result.bins),
         calibration_version)
    )
    return eval_id
```

#### D.7.5 å®Ÿè£…å„ªå…ˆé †ä½

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | å‰ææ¡ä»¶ | å½±éŸ¿ |
|:------:|--------|----------|------|
| **P0** | NLIæ¨è«–ã¸ã®æ ¡æ­£é©ç”¨ï¼ˆStep 1-2ï¼‰ | E2Eãƒ‡ãƒãƒƒã‚°å®Œäº† | å…¨ claim confidence ã«å½±éŸ¿ |
| **P1** | MCPã‚¹ã‚­ãƒ¼ãƒä¸æ•´åˆã®ä¿®æ­£ï¼ˆD.2.2ï¼‰ | P0ã¨åŒæ™‚å¯ | MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æœŸå¾…å€¤èª¿æ•´ |
| **P2** | llm-confidence ã®MCPéœ²å‡ºï¼ˆÂ§3.4.2ï¼‰ | P1å®Œäº†å¾Œ | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®æ„æ€æ±ºå®šæ”¯æ´ |
| **P3** | è©•ä¾¡æ°¸ç¶šåŒ–ï¼ˆStep 3ï¼‰ | P0å®Œäº†å¾Œ | æ ¡æ­£å±¥æ­´ã®è¿½è·¡ |
| **P4** | ãƒ•ã‚¡ã‚¤ãƒ«åå¤‰æ›´ï¼ˆÂ§10.2ï¼‰ | å…¨ã¦å®Œäº†å¾Œ | å¯èª­æ€§å‘ä¸Šã®ã¿ |

#### D.7.5.1 P0 ç²¾å¯†å½±éŸ¿ç¯„å›²ï¼ˆ2024-12-30 èª¿æŸ»ç¢ºå®šï¼‰

**ä¿®æ­£å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«:** `src/filter/nli.py`ï¼ˆ2ç®‡æ‰€ã®ã¿ï¼‰

| è¡Œç•ªå· | ãƒ¡ã‚½ãƒƒãƒ‰ | ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ | ä¿®æ­£å¾Œ |
|--------|----------|--------------|--------|
| 88 | `NLIModel.predict()` | `confidence = result["score"]` | æ ¡æ­£é©ç”¨ |
| 128 | `NLIModel.predict_batch()` | `"confidence": result["score"]` | æ ¡æ­£é©ç”¨ |

**ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆã‚³ãƒ¼ãƒ‰è¿½è·¡ã§ç¢ºèªï¼‰:**
```
src/filter/nli.py:88
  â””â”€â”€ NLIModel.predict() ãŒç”Ÿã‚¹ã‚³ã‚¢ã‚’è¿”å´
       â†“
src/filter/nli.py:222-224
  â””â”€â”€ _nli_judge_local() ãŒ confidence ã‚’ãã®ã¾ã¾çµæœã«å«ã‚ã‚‹
       â†“
src/research/executor.py:977
  â””â”€â”€ nli_conf = float(nli_results[0].get("confidence", 0.0))
       â†“
src/research/executor.py:994
  â””â”€â”€ add_claim_evidence(nli_confidence=nli_conf, ...)
       â†“
src/storage/schema.sql:166
  â””â”€â”€ edges.nli_confidence ã«æ°¸ç¶šåŒ–
       â†“
src/filter/evidence_graph.py:406
  â””â”€â”€ calculate_claim_confidence() ã§ Bayesianæ›´æ–°ã«ä½¿ç”¨
```

**ãƒªãƒ¢ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰è£œè¶³:**
`settings.ml.use_remote=True` ã®å ´åˆã€`src/ml_server/main.py` ã§ã‚‚åŒæ§˜ã®æ ¡æ­£ãŒå¿…è¦ã€‚

**Phase 1 å®Ÿè¡Œå¯å¦: âœ… å¯èƒ½**
- å½±éŸ¿ç¯„å›²ãŒæ˜ç¢ºã«é™å®šã•ã‚Œã¦ã„ã‚‹
- æ—¢å­˜ãƒ†ã‚¹ãƒˆï¼ˆ`tests/test_executor_nli_edges.py`, `tests/test_evidence_graph.py`ï¼‰ã§ã‚«ãƒãƒ¼æ¸ˆã¿
- æ ¡æ­£ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ`src/utils/calibration.py`ï¼‰ã¯å‹•ä½œç¢ºèªæ¸ˆã¿

#### D.7.6 E2Eãƒ‡ãƒãƒƒã‚°ã¸ã®å½±éŸ¿

**ç¾çŠ¶ï¼ˆæ ¡æ­£æœªé©ç”¨ï¼‰ã§ã®æ³¨æ„ç‚¹**:

1. **NLI ã‚¹ã‚³ã‚¢ã®è§£é‡ˆ**: `edges.nli_confidence` ã¯æœªæ ¡æ­£ã®ç”Ÿã‚¹ã‚³ã‚¢ã€‚DeBERTaç³»ãƒ¢ãƒ‡ãƒ«ã¯ä¸€èˆ¬çš„ã«éä¿¡å‚¾å‘ãŒã‚ã‚‹ãŸã‚ã€0.9 ã®ã‚¹ã‚³ã‚¢ãŒå®Ÿéš›ã«ã¯ 0.7-0.8 ç›¸å½“ã®å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚

2. **claim confidence ã®ãƒ‡ãƒãƒƒã‚°**: `calculate_claim_confidence()` ã®å‡ºåŠ›ãŒæœŸå¾…ã¨ç•°ãªã‚‹å ´åˆã€æ ¡æ­£æœªé©ç”¨ãŒåŸå› ã®å¯èƒ½æ€§ã‚’è€ƒæ…®ã€‚

3. **Feedback ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼**: `edge_correct` ã¯æ­£å¸¸å‹•ä½œã™ã‚‹ãŒã€æ–°è¦ã‚¨ãƒƒã‚¸ã¯æœªæ ¡æ­£ã®ã¾ã¾ã€‚è¨‚æ­£å¾Œã® claim confidence æ”¹å–„ãŒé™å®šçš„ãªå¯èƒ½æ€§ã‚ã‚Šã€‚

**æ¨å¥¨**: E2Eãƒ‡ãƒãƒƒã‚°ä¸­ã¯ä»¥ä¸‹ã‚’ç¢ºèªï¼š
- `edges.nli_confidence` ã®åˆ†å¸ƒï¼ˆ0.8-1.0 ã«åã£ã¦ã„ãªã„ã‹ï¼‰
- `calculate_claim_confidence()` ã® uncertainty å€¤ï¼ˆæ¥µç«¯ã«ä½ããªã„ã‹ï¼‰
- æ ¡æ­£é©ç”¨å¾Œã«æ”¹å–„ãŒè¦‹è¾¼ã‚ã‚‹ç®‡æ‰€ã®ç‰¹å®š
