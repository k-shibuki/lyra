# Lyra Test Execution Layers

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€Lyraãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œéšå±¤ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## æ¦‚è¦

Lyraã¯**ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£**ï¼ˆWindows + WSL2 + Podmanã‚³ãƒ³ãƒ†ãƒŠï¼‰ã‚’å‰æã«è¨­è¨ˆã•ã‚Œã¦ãŠã‚Šã€ãƒ†ã‚¹ãƒˆã‚‚ç’°å¢ƒã«å¿œã˜ãŸéšå±¤ã§å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ L3: E2E Layer (Full Environment)                            â”‚
â”‚   - All tests including E2E                                 â”‚
â”‚   - Requires: Chrome CDP, Ollama, GPU, Display              â”‚
â”‚   - Run: pytest (all) or pytest -m e2e                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ L2: Local Layer (Developer WSL2)                            â”‚
â”‚   - Unit + Integration tests                                â”‚
â”‚   - Requires: WSL2, venv, (optional) Podman containers      â”‚
â”‚   - Run: ./scripts/test.sh run                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ L1: CI Layer (Cloud Agent / GitHub Actions)                 â”‚
â”‚   - Unit + Integration tests only                           â”‚
â”‚   - No external services required                           â”‚
â”‚   - Run: pytest -m "not e2e and not slow"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ãƒ†ã‚¹ãƒˆãƒãƒ¼ã‚«ãƒ¼

| ãƒãƒ¼ã‚«ãƒ¼ | èª¬æ˜ | L1 | L2 | L3 |
|----------|------|:--:|:--:|:--:|
| `unit` | å¤–éƒ¨ä¾å­˜ãªã—ã€é«˜é€Ÿ | âœ… | âœ… | âœ… |
| `integration` | ãƒ¢ãƒƒã‚¯åŒ–ã•ã‚ŒãŸå¤–éƒ¨ä¾å­˜ | âœ… | âœ… | âœ… |
| `e2e` | å®Ÿç’°å¢ƒå¿…é ˆ | âŒ | âš ï¸ | âœ… |
| `slow` | 5ç§’ä»¥ä¸Š | âŒ | âš ï¸ | âœ… |
| `external` | E2E + ä¸­ãƒªã‚¹ã‚¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ | âŒ | âŒ | âœ… |
| `rate_limited` | E2E + é«˜ãƒªã‚¹ã‚¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ | âŒ | âŒ | âœ… |
| `manual` | äººé–“ã®ä»‹å…¥å¿…è¦ | âŒ | âŒ | âœ… |

## ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒ

ä»¥ä¸‹ã®ç’°å¢ƒãŒè‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™ï¼š

| ç’°å¢ƒ | æ¤œå‡ºæ–¹æ³• |
|------|----------|
| Cursor Cloud Agent | `CURSOR_CLOUD_AGENT`, `CURSOR_SESSION_ID`, `CURSOR_BACKGROUND` |
| Claude Code | `CLAUDE_CODE` ç’°å¢ƒå¤‰æ•° |
| GitHub Actions | `GITHUB_ACTIONS=true` |
| GitLab CI | `GITLAB_CI` ç’°å¢ƒå¤‰æ•° |
| Generic CI | `CI=true` |
| Headless | DISPLAYãªã—ï¼ˆWSLä»¥å¤–ï¼‰ |

### ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒã§ã®å‹•ä½œ

1. **E2Eãƒ†ã‚¹ãƒˆã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—**: Chrome CDPã€Ollamaç­‰ã®å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨ã§ããªã„ãŸã‚
2. **Slowãƒ†ã‚¹ãƒˆã¯è‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—**: å®Ÿè¡Œæ™‚é–“åˆ¶é™ã®ãŸã‚
3. **Unit/Integrationãƒ†ã‚¹ãƒˆã®ã¿å®Ÿè¡Œ**: ã™ã¹ã¦ãƒ¢ãƒƒã‚¯åŒ–ã•ã‚Œã¦ãŠã‚Šã€å¤–éƒ¨ä¾å­˜ãªã—
4. **ä¾å­˜é–¢ä¿‚ä¸è¶³æ™‚ã®ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—**: å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„å ´åˆã€è©²å½“ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯åé›†ã•ã‚Œã¾ã›ã‚“

### âš ï¸ é‡è¦: ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®è¿½åŠ ãƒ†ã‚¹ãƒˆå®Ÿè¡ŒãŒå¿…è¦

**ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒã§å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æº€ãŸã—ã¦ã„ã¾ã›ã‚“ã€‚**

ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã¯**å¿…ãšãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§è¿½åŠ å®Ÿè¡Œ**ã—ã¦ãã ã•ã„ï¼š

```bash
# E2Eãƒ†ã‚¹ãƒˆï¼ˆChrome CDPã€Ollamaã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¿…è¦ï¼‰
pytest -m e2e

# Slowãƒ†ã‚¹ãƒˆï¼ˆ5ç§’ä»¥ä¸Šã‹ã‹ã‚‹ãƒ†ã‚¹ãƒˆï¼‰
pytest -m slow

# å…¨ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œï¼ˆæ¨å¥¨ï¼‰
pytest
```

ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªé€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ï¼š

```
======================================================================
[Lyra Test] CLOUD AGENT ENVIRONMENT DETECTED
======================================================================
  Agent Type: cursor
  E2E Capable: False

  âš ï¸  E2E/Slow tests are SKIPPED in this environment.
  ğŸ“‹ Please run the following tests LOCALLY:

      pytest -m e2e          # E2E tests (Chrome, Ollama required)
      pytest -m slow         # Slow tests (>5s)
      pytest                 # All tests

======================================================================
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ–¹æ³•

### L1: Cloud Agent / CI

```bash
# è‡ªå‹•çš„ã«é©åˆ‡ãªãƒ†ã‚¹ãƒˆãŒé¸æŠã•ã‚Œã‚‹
./scripts/test.sh run

# ã¾ãŸã¯æ˜ç¤ºçš„ã«
pytest -m "not e2e and not slow"
```

### L2: ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º

```bash
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆunit + integrationï¼‰
./scripts/test.sh run

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
./scripts/test.sh run tests/test_search.py

# E2Eã‚’å«ã‚ã‚‹ï¼ˆPodmanã‚³ãƒ³ãƒ†ãƒŠãŒå¿…è¦ï¼‰
LYRA_TEST_LAYER=e2e ./scripts/test.sh run
```

### L3: ãƒ•ãƒ«ç’°å¢ƒ

```bash
# ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆ
LYRA_TEST_LAYER=all ./scripts/test.sh run

# E2Eã®ã¿
pytest -m e2e

# ç‰¹å®šã®ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«
pytest -m "e2e and external"
pytest -m "e2e and rate_limited"
```

## ç’°å¢ƒæƒ…å ±ã®ç¢ºèª

```bash
# ç¾åœ¨ã®ç’°å¢ƒæ¤œå‡ºçµæœã‚’ç¢ºèª
./scripts/test.sh env
```

å‡ºåŠ›ä¾‹ï¼š
```
=== Lyra Test Environment ===

Environment Detection:
  OS Type: wsl
  In Container: false
  Container Name: N/A
  Is ML Container: false

Cloud Agent Detection:
  Is Cloud Agent: false
  Agent Type: none
  E2E Capable: true

Test Configuration:
  Test Layer: default (unit + integration)
  Markers: not e2e
```

## ç’°å¢ƒå¤‰æ•°

| å¤‰æ•° | èª¬æ˜ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
|------|------|----------|
| `LYRA_TEST_LAYER` | ãƒ†ã‚¹ãƒˆå±¤ã®æŒ‡å®šï¼ˆ`e2e`, `all`ï¼‰ | è‡ªå‹•æ¤œå‡º |
| `LYRA_LOCAL` | ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã‚’å¼·åˆ¶ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰æ¤œå‡ºã‚’ç„¡åŠ¹åŒ–ï¼‰ | - |
| `LYRA_HEADLESS` | ãƒ˜ãƒƒãƒ‰ãƒ¬ã‚¹E2Eã‚’æœ‰åŠ¹åŒ– | `false` |

## ãƒ¢ãƒƒã‚¯æˆ¦ç•¥ (Â§7.1.7)

Unit/Integrationãƒ†ã‚¹ãƒˆã§ã¯ä»¥ä¸‹ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ¢ãƒƒã‚¯åŒ–ï¼š

- **Ollama (LLM)**: `mock_ollama` ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
- **Chrome/Playwright**: `mock_browser` ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
- **Database**: `memory_database` ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ï¼ˆã‚¤ãƒ³ãƒ¡ãƒ¢ãƒªSQLiteï¼‰
- **Network**: `aioresponses` / `responses` ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

## E2Eç’°å¢ƒã®æº–å‚™

E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ä»¥ä¸‹ã®æº–å‚™ãŒå¿…è¦ï¼š

1. **Chromeã®èµ·å‹•**
   ```bash
   ./scripts/chrome.sh start
   ```

2. **Podmanã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•**
   ```bash
   ./scripts/dev.sh up
   ```

3. **ç’°å¢ƒç¢ºèª**
   ```bash
   python tests/scripts/verify_environment.py
   ```

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã§ãƒ†ã‚¹ãƒˆãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹

ã“ã‚Œã¯æ„å›³ã•ã‚ŒãŸå‹•ä½œã§ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç’°å¢ƒã§ã¯å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€E2Eãƒ†ã‚¹ãƒˆã¯è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚

å¼·åˆ¶çš„ã«ãƒ­ãƒ¼ã‚«ãƒ«ãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã™ã‚‹å ´åˆï¼š
```bash
LYRA_LOCAL=1 ./scripts/test.sh run
```

### E2Eãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã™ã‚‹

1. Chrome CDPãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼š
   ```bash
   ./scripts/chrome.sh diagnose
   ```

2. Podmanã‚³ãƒ³ãƒ†ãƒŠãŒç¨¼åƒã—ã¦ã„ã‚‹ã‹ç¢ºèªï¼š
   ```bash
   podman ps
   ```

3. ç’°å¢ƒæ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œï¼š
   ```bash
   python tests/scripts/verify_environment.py
   ```

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [è¦ä»¶å®šç¾©æ›¸](requirements.md) - Â§7 å—ã‘å…¥ã‚ŒåŸºæº–
- [å®Ÿè£…è¨ˆç”»æ›¸](IMPLEMENTATION_PLAN.md) - Phase G ãƒ†ã‚¹ãƒˆåŸºç›¤
