# æ¤œç´¢ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½

> **Status**: ğŸ”œ PLANNEDï¼ˆå®Ÿè£…å¾…ã¡ï¼‰

> **Scope / Assumptions**:
> - Q_ASYNC_ARCHITECTURE.md å®Œäº†å¾Œã«ç€æ‰‹
> - ADR-0010 ã¸ã®è¿½è¨˜ã§å¯¾å¿œï¼ˆæ–°è¦ADRä¸è¦ï¼‰
> - æ—¢å­˜ã‚³ãƒ¼ãƒ‰è³‡ç”£ã®æ‹¡å¼µã§å®Ÿè£…å¯èƒ½

## Executive Summary

**å•é¡Œã®æœ¬è³ª:** ç¾åœ¨ã®æ¤œç´¢æ©Ÿèƒ½ã¯çµæœã®1ãƒšãƒ¼ã‚¸ç›®ã®ã¿å–å¾—å¯èƒ½ã€‚2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã®çµæœã«ã¯åˆ°é”ã§ããªã„ã€‚

**è§£æ±ºç­–:** ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€è¤‡æ•°ãƒšãƒ¼ã‚¸ã®çµæœã‚’å–å¾—å¯èƒ½ã«ã™ã‚‹
- `SearchOptions.page` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®Ÿéš›ã«ä½¿ç”¨
- å„ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³URLæ§‹ç¯‰å¯¾å¿œ
- è‡ªå‹•åœæ­¢åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé£½å’Œæ¤œçŸ¥ãƒ»åç©«ç‡ãƒ™ãƒ¼ã‚¹ï¼‰

**å·¥æ•°è¦‹ç©:** ç´„9æ™‚é–“ï¼ˆ1.5æ—¥ï¼‰

---

## 1. ç¾çŠ¶ã®å•é¡Œç‚¹

### 1.1 åˆ°é”ã§ããªã„ãƒšãƒ¼ã‚¸

| ã‚«ãƒ†ã‚´ãƒª | å•é¡Œ | å½±éŸ¿åº¦ |
|---------|------|--------|
| ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æœªå®Ÿè£… | æ¤œç´¢çµæœã®2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã«åˆ°é”ä¸å¯ | **é«˜** |
| æœªå®Ÿè£…ã‚¨ãƒ³ã‚¸ãƒ³ | Wikipedia, Arxivç­‰ã«ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | ä¸­ |
| æ—¥æ¬¡åˆ¶é™ | Google/Bing: 10å›/æ—¥ | ä¸­ |
| CAPTCHA | botæ¤œå‡ºã§ãƒ–ãƒ­ãƒƒã‚¯ | ä½ï¼ˆä»‹å…¥ã‚­ãƒ¥ãƒ¼ã§å¯¾å¿œï¼‰ |

### 1.2 ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æœªå®Ÿè£…ã®è©³ç´°

**ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰:**
```python
# src/search/browser_search_provider.py:948
results = [r.to_search_result(engine) for r in parse_result.results[: options.limit]]
```

- `SearchOptions.page` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å®šç¾©æ¸ˆã¿ã ãŒ**æœªä½¿ç”¨**
- æœ€å¤§å–å¾—ä»¶æ•°: 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Š10ã€œ100ä»¶
- æ¬¡ãƒšãƒ¼ã‚¸å–å¾—æ‰‹æ®µãªã—

### 1.3 æœªå®Ÿè£…ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆãƒ‘ãƒ¼ã‚µãƒ¼ãªã—ï¼‰

| ã‚¨ãƒ³ã‚¸ãƒ³ | çŠ¶æ…‹ | å‚™è€ƒ |
|---------|------|------|
| Wikipedia | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | ãƒŠãƒ¬ãƒƒã‚¸ã‚½ãƒ¼ã‚¹ |
| Wikidata | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ |
| Marginalia | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼Webæ¤œç´¢ |
| Arxiv | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | APIã¯åˆ¥é€”å®Ÿè£…ã‚ã‚Š |
| PubMed | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | APIã¯åˆ¥é€”å®Ÿè£…ã‚ã‚Š |
| Qwant | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–æ¤œç´¢ |

### 1.4 æ—¥æ¬¡åˆ¶é™ï¼ˆADR-0010ï¼‰

| ã‚¨ãƒ³ã‚¸ãƒ³ | æ—¥æ¬¡åˆ¶é™ | QPS | å‚™è€ƒ |
|---------|---------|-----|------|
| Google | 10å›/æ—¥ | 0.05 | ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒ« |
| Bing | 10å›/æ—¥ | 0.05 | ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒ« |
| Brave | 50å›/æ—¥ | 0.1 | ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒ« |
| Mojeek | åˆ¶é™ãªã— | 0.25 | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
| DuckDuckGo | åˆ¶é™ãªã— | 0.2 | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |

---

## 2. è§£æ±ºç­–

### 2.1 æ—¢å­˜è³‡ç”£ã®æ´»ç”¨

| è¦ç´  | å ´æ‰€ | çŠ¶æ…‹ |
|------|------|------|
| `page` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | `SearchOptions` (provider.py:141) | å®šç¾©æ¸ˆã¿ãƒ»æœªä½¿ç”¨ |
| URLæ§‹ç¯‰åŸºç›¤ | `build_search_url()` | å®Ÿè£…æ¸ˆã¿ |
| çµæœãƒ‘ãƒ¼ã‚µãƒ¼ | `search_parsers.py` | 7ã‚¨ãƒ³ã‚¸ãƒ³å¯¾å¿œæ¸ˆã¿ |
| è¨­å®šå¤–éƒ¨åŒ– | `config/search_parsers.yaml` | å®Ÿè£…æ¸ˆã¿ |

### 2.2 å„ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

| ã‚¨ãƒ³ã‚¸ãƒ³ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å½¢å¼ | ä¾‹ï¼ˆ2ãƒšãƒ¼ã‚¸ç›®ï¼‰ | çµæœæ•°/ãƒšãƒ¼ã‚¸ |
|---------|---------------|-----------------|---------------|
| DuckDuckGo | `s={offset}` | `s=30` | ç´„30ä»¶ |
| Google | `start={offset}` | `start=10` | 10ä»¶ |
| Bing | `first={offset}` | `first=11` | 10ä»¶ |
| Mojeek | `s={offset}` | `s=10` | 10ä»¶ |
| Brave | `offset={offset}` | `offset=10` | 10ä»¶ |
| Ecosia | `p={page}` | `p=1` | 10ä»¶ |
| Startpage | `page={page}` | `page=2` | 10ä»¶ |

**æ³¨æ„**: offsetæ–¹å¼ã¨pageæ–¹å¼ãŒæ··åœ¨ã€‚æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒå¿…è¦ã€‚

---

## 3. åœæ­¢åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯

### 3.1 ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¯”è¼ƒ

| æ–¹å¼ | èª¬æ˜ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|------|------|----------|------------|
| å›ºå®šãƒšãƒ¼ã‚¸æ•° | å¸¸ã«Næšå–å¾— | äºˆæ¸¬å¯èƒ½ã€ã‚·ãƒ³ãƒ—ãƒ« | éåŠ¹ç‡ |
| é£½å’Œæ¤œçŸ¥ | æ–°è¦URLç‡ã§åˆ¤å®š | é©å¿œçš„ | ãƒ‰ãƒ¡ã‚¤ãƒ³å¤šæ§˜æ€§ç„¡è¦– |
| åç©«ç‡ãƒ™ãƒ¼ã‚¹ | é–¢é€£ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆç‡ã§åˆ¤å®š | Lyraå›ºæœ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ´»ç”¨ | è¨ˆç®—ã‚³ã‚¹ãƒˆ |
| LLMåˆ¤æ–­ | ã‚¯ã‚¨ãƒªæ€§è³ªã‚’è§£æ | é«˜ç²¾åº¦ | é«˜ã‚³ã‚¹ãƒˆã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· |

### 3.2 æ¨å¥¨: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

```python
class PaginationStrategy:
    max_pages: int = 5           # çµ¶å¯¾ä¸Šé™
    min_novelty_rate: float = 0.2  # æ–°è¦URLç‡ã®ä¸‹é™
    min_harvest_rate: float = 0.05 # åç©«ç‡ã®ä¸‹é™

    def should_fetch_next(
        self,
        current_page: int,
        novelty_rate: float,
        harvest_rate: float,
    ) -> bool:
        if current_page >= self.max_pages:
            return False
        if novelty_rate < self.min_novelty_rate:
            return False
        if harvest_rate < self.min_harvest_rate:
            return False
        return True
```

### 3.3 Lyraæ—¢å­˜ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ´»ç”¨

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | ãƒ†ãƒ¼ãƒ–ãƒ«/ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | æ´»ç”¨æ–¹æ³• |
|-----------|-------------------|----------|
| åç©«ç‡ | `queries.harvest_rate` | é–¾å€¤åˆ¤å®š |
| URLé‡è¤‡ | `serp_items.url` | é£½å’Œæ¤œçŸ¥ |
| ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ | `_detect_category()` | æ·±åº¦ãƒ—ãƒªã‚»ãƒƒãƒˆ |
| ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹ | `engine_health` | å–å¾—å¯èƒ½æ€§åˆ¤å®š |

**çµè«–**: LLMåˆ¤æ–­ã¯ä¸è¦ã€‚æ©Ÿæ¢°çš„ãƒ«ãƒ¼ãƒ« + æ—¢å­˜ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ååˆ†ã€‚

---

## 4. å®Ÿè£…è¨ˆç”»

### 4.1 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´

**ãƒ•ã‚¡ã‚¤ãƒ«**: `config/search_parsers.yaml`

```yaml
# å„ã‚¨ãƒ³ã‚¸ãƒ³ã«è¿½åŠ 
duckduckgo:
  search_url: "https://duckduckgo.com/?q={query}&kl={region}&df={time_range}&s={offset}"
  results_per_page: 30
  pagination_type: "offset"  # offset | page

mojeek:
  search_url: "https://www.mojeek.com/search?q={query}&t={time_range}&s={offset}"
  results_per_page: 10
  pagination_type: "offset"
```

### 4.2 ã‚³ãƒ¼ãƒ‰å¤‰æ›´

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ | è¡Œæ•°ç›®å®‰ |
|---------|---------|---------|
| `src/search/parser_config.py` | ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šèª­ã¿è¾¼ã¿ | +15è¡Œ |
| `src/search/search_parsers.py` | `build_search_url()` ã«offset/pageå¯¾å¿œ | +10è¡Œ |
| `src/search/browser_search_provider.py` | `search()` ã§pageæ´»ç”¨ | +20è¡Œ |
| `src/search/provider.py` | `SearchResponse` ã«pageæƒ…å ±è¿½åŠ ï¼ˆä»»æ„ï¼‰ | +5è¡Œ |

### 4.3 æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/search/pagination_strategy.py`

```python
@dataclass
class PaginationConfig:
    max_pages: int = 5
    min_novelty_rate: float = 0.2
    min_harvest_rate: float = 0.05
    strategy: Literal["fixed", "auto", "exhaustive"] = "auto"

class PaginationStrategy:
    def __init__(self, config: PaginationConfig): ...
    def should_fetch_next(self, context: PaginationContext) -> bool: ...
    def calculate_novelty_rate(self, new_urls: list[str], seen_urls: set[str]) -> float: ...
```

### 4.4 DBå¤‰æ›´ï¼ˆä»»æ„ï¼‰

```sql
-- serp_items ã«è¿½åŠ ï¼ˆæ¨å¥¨ï¼‰
ALTER TABLE serp_items ADD COLUMN page_number INTEGER DEFAULT 1;
```

---

## 5. å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| ä½œæ¥­ | é›£æ˜“åº¦ | å·¥æ•° |
|------|--------|------|
| search_parsers.yaml æ›´æ–° | ä½ | 0.5h |
| parser_config.py æ›´æ–° | ä½ | 1h |
| browser_search_provider.py æ›´æ–° | ä¸­ | 2h |
| pagination_strategy.py æ–°è¦ä½œæˆ | ä¸­ | 2h |
| ãƒ†ã‚¹ãƒˆè¿½åŠ  | ä¸­ | 2h |
| çµåˆãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚° | ä¸­ | 1.5h |
| **åˆè¨ˆ** | | **9hï¼ˆç´„1.5æ—¥ï¼‰** |

---

## 6. ADRåˆ¤æ–­

### çµè«–: æ–°è¦ADRä¸è¦ã€ADR-0010ã¸ã®è¿½è¨˜ã§å¯¾å¿œ

**ç†ç”±:**
- ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ã¯æ—¢å­˜ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ‹¡å¼µ
- `queue_searches` ã®ä»•æ§˜æ‹¡å¼µã¨ã—ã¦è‡ªç„¶ã«åã¾ã‚‹
- é‡å¤§ãªãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•æ±ºå®šã¯å«ã¾ã‚Œãªã„

### ADR-0010ã¸ã®è¿½è¨˜æ¡ˆ

```markdown
### Pagination Strategy

æ¤œç´¢çµæœã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡:

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|-----------|-----------|------|
| max_pages | 3 | å–å¾—ã™ã‚‹æœ€å¤§ãƒšãƒ¼ã‚¸æ•° |
| stop_strategy | "auto" | åœæ­¢æˆ¦ç•¥ (fixed/auto/exhaustive) |

**è‡ªå‹•åœæ­¢æ¡ä»¶** (strategy="auto"):
- æ–°è¦URLç‡ < 20%
- åç©«ç‡ < 5%
- max_pagesåˆ°é”
```

---

## 7. æ³¨æ„äº‹é …

### 7.1 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¨ã®å…¼ã­åˆã„

ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§è¤‡æ•°ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹ã¨:
- QPSåˆ¶é™ã«ã²ã£ã‹ã‹ã‚Šã‚„ã™ã„
- æ—¥æ¬¡åˆ¶é™ã‚’æ—©ãæ¶ˆè²»ã™ã‚‹
- CAPTCHAãƒªã‚¹ã‚¯ãŒä¸Šæ˜‡

**å¯¾ç­–**: ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆGoogle/Bing/Braveï¼‰ã¯ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ã‚’æ¤œè¨ã€‚

### 7.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•´åˆæ€§

```python
# ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
cache_key = f"{normalized_query}|{engines}|{time_range}"

# å¤‰æ›´å¾Œï¼ˆpageè¿½åŠ ï¼‰
cache_key = f"{normalized_query}|{engines}|{time_range}|page={page}"
```

### 7.3 çµæœã®ãƒãƒ¼ã‚¸

è¤‡æ•°ãƒšãƒ¼ã‚¸ã®çµæœã‚’ãƒãƒ¼ã‚¸ã™ã‚‹éš›:
- URLé‡è¤‡æ’é™¤ãŒå¿…è¦
- rank ã®å†è¨ˆç®—ãŒå¿…è¦
- ã‚¨ãƒ³ã‚¸ãƒ³é–“ã®çµæœæ··åˆã«æ³¨æ„

---

## 8. å®Ÿè£…ã‚¿ã‚¹ã‚¯

### Phase 1: åŸºç›¤æ•´å‚™
- [ ] `config/search_parsers.yaml` ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ 
- [ ] `src/search/parser_config.py` ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šèª­ã¿è¾¼ã¿
- [ ] `build_search_url()` ã«offset/pageå¼•æ•°è¿½åŠ 

### Phase 2: æ¤œç´¢ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œ
- [ ] `browser_search_provider.py` ã§ `options.page` ã‚’ä½¿ç”¨
- [ ] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«ãƒšãƒ¼ã‚¸ç•ªå·å«ã‚ã‚‹
- [ ] `SearchResponse` ã«ãƒšãƒ¼ã‚¸æƒ…å ±è¿½åŠ ï¼ˆä»»æ„ï¼‰

### Phase 3: åœæ­¢åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯
- [ ] `pagination_strategy.py` æ–°è¦ä½œæˆ
- [ ] é£½å’Œæ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…
- [ ] åç©«ç‡ãƒ™ãƒ¼ã‚¹åœæ­¢å®Ÿè£…
- [ ] è¨­å®šå¯èƒ½ãªã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼é¸æŠ

### Phase 4: çµ±åˆãƒ»ãƒ†ã‚¹ãƒˆ
- [ ] å˜ä½“ãƒ†ã‚¹ãƒˆè¿½åŠ 
- [ ] çµåˆãƒ†ã‚¹ãƒˆï¼ˆå®Ÿã‚¨ãƒ³ã‚¸ãƒ³ï¼‰
- [ ] ADR-0010ã¸ã®è¿½è¨˜

### Phase 5: DBæ‹¡å¼µï¼ˆä»»æ„ï¼‰
- [ ] `serp_items.page_number` ã‚«ãƒ©ãƒ è¿½åŠ 
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ

---

## 9. å‚è€ƒè³‡æ–™

- `src/search/browser_search_provider.py` - æ¤œç´¢ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å®Ÿè£…
- `src/search/provider.py` - SearchOptions, SearchResponseå®šç¾©
- `src/search/search_parsers.py` - å„ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ‘ãƒ¼ã‚µãƒ¼
- `config/search_parsers.yaml` - ãƒ‘ãƒ¼ã‚µãƒ¼è¨­å®š
- `docs/adr/0010-async-search-queue.md` - éåŒæœŸæ¤œç´¢ã‚­ãƒ¥ãƒ¼ADR
- `src/storage/schema.sql` - DBã‚¹ã‚­ãƒ¼ãƒ
