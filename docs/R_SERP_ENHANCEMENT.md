# SERP Enhancementï¼ˆãƒ–ãƒ©ã‚¦ã‚¶æ¤œç´¢å¼·åŒ–ï¼‰

> **Status**: âš ï¸ MOSTLY DONEï¼ˆæ®‹ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼‰
>
> **Phase Mapping**: [ADR-0010](adr/0010-async-search-queue.md) **Phase 5** ã¨ã—ã¦å®Ÿè£…
> **Related ADRs**: ADR-0014ï¼ˆBrowser SERP Resource Controlï¼‰, ADR-0015ï¼ˆAdaptive Concurrencyï¼‰

> **Scope / Assumptions**:
> - ADR-0010 Phase 4 å®Œäº†å¾Œã«ç€æ‰‹ï¼ˆPhase 5 ã§å®Ÿè£…ï¼‰
> - ADR-0014ï¼ˆBrowser SERP Resource Controlï¼‰ã‚’å‰æ
> - æ—¢å­˜ã‚³ãƒ¼ãƒ‰è³‡ç”£ã®æ‹¡å¼µã§å®Ÿè£…å¯èƒ½
> - **å®Ÿè£…**: 2025-12-25ï¼ˆä¸»è¦æ©Ÿèƒ½å®Œäº†ã€ä¸€éƒ¨æ®‹ã‚¿ã‚¹ã‚¯ã‚ã‚Šï¼‰

## Executive Summary

**å•é¡Œã®æœ¬è³ª:** ç¾åœ¨ã®æ¤œç´¢æ©Ÿèƒ½ã¯çµæœã®1ãƒšãƒ¼ã‚¸ç›®ã®ã¿å–å¾—å¯èƒ½ã€‚2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã®çµæœã«ã¯åˆ°é”ã§ããªã„ã€‚

**è§£æ±ºç­–:** ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã€è¤‡æ•°ãƒšãƒ¼ã‚¸ã®çµæœã‚’å–å¾—å¯èƒ½ã«ã™ã‚‹
- `SearchOptions.serp_page` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®Ÿéš›ã«ä½¿ç”¨ï¼ˆæ—§ `SearchOptions.page` ã¯å‰Šé™¤æ¸ˆã¿ / äº’æ›ãªã—ï¼‰
- å„ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³URLæ§‹ç¯‰å¯¾å¿œ
- è‡ªå‹•åœæ­¢åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆé£½å’Œæ¤œçŸ¥ãƒ»åç©«ç‡ãƒ™ãƒ¼ã‚¹ï¼‰

**å‰ææ¡ä»¶:** ADR-0014 ã§å®šç¾©ã•ã‚ŒãŸ TabPoolï¼ˆmax_tabs=1ï¼‰å°å…¥ã«ã‚ˆã‚Šã€ãƒ–ãƒ©ã‚¦ã‚¶SERPãŒã€ŒPageç«¶åˆãªã—ã€ã§å®Ÿè¡Œã§ãã‚‹ã“ã¨

**å·¥æ•°è¦‹ç©:** ç´„10æ™‚é–“ï¼ˆ1.5æ—¥ï¼‰â€»ADR-0014ï¼ˆTabPoolå°å…¥ï¼‰å®Œäº†å¾Œ

---

## 1. ç¾çŠ¶ã®å•é¡Œç‚¹

### 1.1 åˆ°é”ã§ããªã„ãƒšãƒ¼ã‚¸

| ã‚«ãƒ†ã‚´ãƒª | å•é¡Œ | å½±éŸ¿åº¦ |
|---------|------|--------|
| ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æœªå®Ÿè£… | æ¤œç´¢çµæœã®2ãƒšãƒ¼ã‚¸ç›®ä»¥é™ã«åˆ°é”ä¸å¯ | **é«˜** |
| æœªå®Ÿè£…ã‚¨ãƒ³ã‚¸ãƒ³ | Wikipedia, Arxivç­‰ã«ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | ä¸­ |
| æ—¥æ¬¡åˆ¶é™ | Google/Bing: 10å›/æ—¥ | ä¸­ |
| CAPTCHA | botæ¤œå‡ºã§ãƒ–ãƒ­ãƒƒã‚¯ | ä½ï¼ˆä»‹å…¥ã‚­ãƒ¥ãƒ¼ã§å¯¾å¿œï¼‰ |

### 1.2 ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³æœªå®Ÿè£…ã®è©³ç´°

**ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰:**
```python
# src/search/browser_search_provider.py:948
results = [r.to_search_result(engine) for r in parse_result.results[: options.limit]]
```

- `SearchOptions.serp_page` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å®šç¾©æ¸ˆã¿ã ãŒ**æœªä½¿ç”¨**
- æœ€å¤§å–å¾—ä»¶æ•°: 1ãƒšãƒ¼ã‚¸ã‚ãŸã‚Š10ã€œ100ä»¶
- æ¬¡ãƒšãƒ¼ã‚¸å–å¾—æ‰‹æ®µãªã—

### 1.3 æœªå®Ÿè£…ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆãƒ‘ãƒ¼ã‚µãƒ¼ãªã—ï¼‰

| ã‚¨ãƒ³ã‚¸ãƒ³ | çŠ¶æ…‹ | å‚™è€ƒ |
|---------|------|------|
| Wikipedia | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | ãƒŠãƒ¬ãƒƒã‚¸ã‚½ãƒ¼ã‚¹ |
| Wikidata | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ |
| Marginalia | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼Webæ¤œç´¢ |
| Arxiv | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | APIã¯åˆ¥é€”å®Ÿè£…ã‚ã‚Š |
| PubMed | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | APIã¯åˆ¥é€”å®Ÿè£…ã‚ã‚Š |
| Qwant | ãƒ‘ãƒ¼ã‚µãƒ¼ãªã— | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é‡è¦–æ¤œç´¢ |

### 1.4 æ—¥æ¬¡åˆ¶é™ï¼ˆADR-0010ï¼‰

| ã‚¨ãƒ³ã‚¸ãƒ³ | æ—¥æ¬¡åˆ¶é™ | QPS | å‚™è€ƒ |
|---------|---------|-----|------|
| Google | 10å›/æ—¥ | 0.05 | ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒ« |
| Bing | 10å›/æ—¥ | 0.05 | ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒ« |
| Brave | 50å›/æ—¥ | 0.1 | ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒ« |
| Mojeek | åˆ¶é™ãªã— | 0.25 | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |
| DuckDuckGo | åˆ¶é™ãªã— | 0.2 | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ |

---

## 2. è§£æ±ºç­–

### 2.1 æ—¢å­˜è³‡ç”£ã®æ´»ç”¨

| è¦ç´  | å ´æ‰€ | çŠ¶æ…‹ |
|------|------|------|
| `page` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | `SearchOptions` (provider.py:141) | å®šç¾©æ¸ˆã¿ãƒ»æœªä½¿ç”¨ |
| URLæ§‹ç¯‰åŸºç›¤ | `build_search_url()` | å®Ÿè£…æ¸ˆã¿ |
| çµæœãƒ‘ãƒ¼ã‚µãƒ¼ | `search_parsers.py` | 7ã‚¨ãƒ³ã‚¸ãƒ³å¯¾å¿œæ¸ˆã¿ |
| è¨­å®šå¤–éƒ¨åŒ– | `config/search_parsers.yaml` | å®Ÿè£…æ¸ˆã¿ï¼ˆURLãƒ†ãƒ³ãƒ—ãƒ¬/selectorï¼‰ |
| ã‚¨ãƒ³ã‚¸ãƒ³policy | `config/engines.yaml` | å®Ÿè£…æ¸ˆã¿ï¼ˆQPS/åˆ©ç”¨å¯å¦/é‡ã¿ç­‰ï¼‰ |
| **TabPoolï¼ˆPageç«¶åˆæ’é™¤ï¼‰** | `BrowserSearchProvider` | **ADR-0014ã§å®Ÿè£…äºˆå®š** |

### 2.2 å„ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

**serp_page ã®ä»•æ§˜:**
- **1å§‹ã¾ã‚Š**ï¼ˆ1ãƒšãƒ¼ã‚¸ç›® = `serp_page=1`ï¼‰
- å®Ÿè£…: `src/search/provider.py` ã® `SearchOptions.serp_page` ã¯ `default=1, ge=1` ã§å®šç¾©æ¸ˆã¿
- offsetè¨ˆç®—ã®åŸºæœ¬å¼: `offset = (serp_page - 1) * results_per_page`

**ã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã¨ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³:**
- 1å›ã®æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¯¾ã—ã¦**1ã¤ã®ã‚¨ãƒ³ã‚¸ãƒ³ãŒé¸æŠ**ã•ã‚Œã‚‹ï¼ˆé‡ã¿ä»˜ãé¸æŠï¼‰
- é¸æŠã•ã‚ŒãŸã‚¨ãƒ³ã‚¸ãƒ³ã§ `serp_max_pages` ã¾ã§å–å¾—
- **ã©ã®ã‚¨ãƒ³ã‚¸ãƒ³ãŒé¸æŠã•ã‚Œã¦ã‚‚ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãŒæ©Ÿèƒ½**ã™ã‚‹è¨­è¨ˆ

| ã‚¨ãƒ³ã‚¸ãƒ³ | ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å½¢å¼ | è¨ˆç®—å¼ï¼ˆserp_page=Nï¼‰ | ä¾‹ï¼ˆ2ãƒšãƒ¼ã‚¸ç›®ï¼‰ | çµæœæ•°/ãƒšãƒ¼ã‚¸ |
|---------|---------------|----------------------|-----------------|---------------|
| DuckDuckGo | `s={offset}` | `s = (N - 1) * 30` | `s=30` | ç´„30ä»¶ |
| Google | `start={offset}` | `start = (N - 1) * 10` | `start=10` | 10ä»¶ |
| Bing | `first={offset}` | `first = (N - 1) * 10 + 1` | `first=11` | 10ä»¶ |
| Mojeek | `s={offset}` | `s = (N - 1) * 10` | `s=10` | 10ä»¶ |
| Brave | `offset={offset}` | `offset = (N - 1) * 10` | `offset=10` | 10ä»¶ |
| Ecosia | `p={page}` | `p = N - 1` | `p=1` | 10ä»¶ |
| Startpage | `page={page}` | `page = N` | `page=2` | 10ä»¶ |

**æ³¨æ„**: offsetæ–¹å¼ã¨pageæ–¹å¼ãŒæ··åœ¨ã€‚`config/search_parsers.yaml` ã® `pagination_type` ã§æŠ½è±¡åŒ–ã€‚

---

## 3. åœæ­¢åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯

### 3.1 ã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ¯”è¼ƒ

| æ–¹å¼ | èª¬æ˜ | ãƒ¡ãƒªãƒƒãƒˆ | ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ |
|------|------|----------|------------|
| å›ºå®šãƒšãƒ¼ã‚¸æ•° | å¸¸ã«Næšå–å¾— | äºˆæ¸¬å¯èƒ½ã€ã‚·ãƒ³ãƒ—ãƒ« | éåŠ¹ç‡ |
| é£½å’Œæ¤œçŸ¥ | æ–°è¦URLç‡ã§åˆ¤å®š | é©å¿œçš„ | ãƒ‰ãƒ¡ã‚¤ãƒ³å¤šæ§˜æ€§ç„¡è¦– |
| åç©«ç‡ãƒ™ãƒ¼ã‚¹ | é–¢é€£ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆç‡ã§åˆ¤å®š | Lyraå›ºæœ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ´»ç”¨ | è¨ˆç®—ã‚³ã‚¹ãƒˆ |
| LLMåˆ¤æ–­ | ã‚¯ã‚¨ãƒªæ€§è³ªã‚’è§£æ | é«˜ç²¾åº¦ | é«˜ã‚³ã‚¹ãƒˆã€ãƒ¬ã‚¤ãƒ†ãƒ³ã‚· |

### 3.2 æ¨å¥¨: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

```python
class PaginationStrategy:
    serp_max_pages: int = 10       # çµ¶å¯¾ä¸Šé™ï¼ˆSERPãƒšãƒ¼ã‚¸æ•°ï¼‰â†’ 100ã€œ300ä»¶å–å¾—å¯èƒ½
    min_novelty_rate: float = 0.1  # æ–°è¦URLç‡ã®ä¸‹é™ï¼ˆstate.py ã®æ—¢å­˜é–¾å€¤ã¨æ•´åˆï¼‰
    min_harvest_rate: float = 0.05 # åç©«ç‡ã®ä¸‹é™

    def should_fetch_next(
        self,
        current_page: int,
        novelty_rate: float,
        harvest_rate: float,
    ) -> bool:
        if current_page >= self.serp_max_pages:
            return False
        if novelty_rate < self.min_novelty_rate:
            return False
        if harvest_rate < self.min_harvest_rate:
            return False
        return True
```

### 3.3 Lyraæ—¢å­˜ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®æ´»ç”¨

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | ãƒ†ãƒ¼ãƒ–ãƒ«/ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | æ´»ç”¨æ–¹æ³• |
|-----------|-------------------|----------|
| åç©«ç‡ | `queries.harvest_rate` | é–¾å€¤åˆ¤å®š |
| URLé‡è¤‡ | `serp_items.url` | é£½å’Œæ¤œçŸ¥ |
| ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ | `_detect_category()` | æ·±åº¦ãƒ—ãƒªã‚»ãƒƒãƒˆ |
| ã‚¨ãƒ³ã‚¸ãƒ³çŠ¶æ…‹ | `engine_health` | å–å¾—å¯èƒ½æ€§åˆ¤å®š |

**çµè«–**: LLMåˆ¤æ–­ã¯ä¸è¦ã€‚æ©Ÿæ¢°çš„ãƒ«ãƒ¼ãƒ« + æ—¢å­˜ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã§ååˆ†ã€‚

---

## 4. å®Ÿè£…è¨ˆç”»

### 4.1 è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´

**ãƒ•ã‚¡ã‚¤ãƒ«**: `config/search_parsers.yaml`ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã®URL/çµæœæ•°ï¼‰

```yaml
# å„ã‚¨ãƒ³ã‚¸ãƒ³ã«è¿½åŠ 
duckduckgo:
  search_url: "https://duckduckgo.com/?q={query}&kl={region}&df={time_range}&s={offset}"
  results_per_page: 30
  pagination_type: "offset"  # offset | page

mojeek:
  search_url: "https://www.mojeek.com/search?q={query}&t={time_range}&s={offset}"
  results_per_page: 10
  pagination_type: "offset"
```

### 4.2 ã‚³ãƒ¼ãƒ‰å¤‰æ›´

| ãƒ•ã‚¡ã‚¤ãƒ« | å¤‰æ›´å†…å®¹ | è¡Œæ•°ç›®å®‰ |
|---------|---------|---------|
| `src/search/parser_config.py` | ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šèª­ã¿è¾¼ã¿ | +15è¡Œ |
| `src/search/search_parsers.py` | `build_search_url()` ã«offset/pageå¯¾å¿œ | +10è¡Œ |
| `src/search/browser_search_provider.py` | `search()` ã§pageæ´»ç”¨ | +20è¡Œ |
| `src/search/provider.py` | `SearchResponse` ã«pageæƒ…å ±è¿½åŠ ï¼ˆä»»æ„ï¼‰ | +5è¡Œ |

### 4.3 æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/search/pagination_strategy.py`

```python
@dataclass
class PaginationConfig:
    serp_max_pages: int = 10       # 100ã€œ300ä»¶å–å¾—å¯èƒ½ï¼ˆã‚¨ãƒ³ã‚¸ãƒ³ã«ã‚ˆã‚Š10ã€œ30ä»¶/ãƒšãƒ¼ã‚¸ï¼‰
    min_novelty_rate: float = 0.1  # state.py ã®æ—¢å­˜é–¾å€¤ï¼ˆnovelty_score < 0.1 ã§ EXHAUSTEDï¼‰ã¨æ•´åˆ
    min_harvest_rate: float = 0.05
    strategy: Literal["fixed", "auto", "exhaustive"] = "auto"

class PaginationStrategy:
    def __init__(self, config: PaginationConfig): ...
    def should_fetch_next(self, context: PaginationContext) -> bool: ...
    def calculate_novelty_rate(self, new_urls: list[str], seen_urls: set[str]) -> float: ...
```

### 4.4 DBå¤‰æ›´ï¼ˆå¿…é ˆï¼‰

```sql
-- serp_items ã«è¿½åŠ ï¼ˆç›£æŸ»/å†ç¾æ€§ã‚’DBå´ã§æ‹…ä¿ï¼‰
ALTER TABLE serp_items ADD COLUMN page_number INTEGER DEFAULT 1;
```

**è¨­è¨ˆåˆ¤æ–­:**
- `serp_items.page_number` ã¯ **å¿…é ˆ** ã¨ã™ã‚‹
- ç›£æŸ»/å†ç¾æ€§ã‚’DBå´ã§æ‹…ä¿ï¼ˆã©ã®SERPãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã•ã‚ŒãŸã‹ã‚’è¿½è·¡å¯èƒ½ï¼‰
- `jobs.output_json` ã¸ã®ä¾å­˜ã‚’é¿ã‘ã€æ­£è¦åŒ–ã•ã‚ŒãŸå½¢ã§ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒ

---

## 5. å·¥æ•°è¦‹ç©ã‚‚ã‚Š

| ä½œæ¥­ | é›£æ˜“åº¦ | å·¥æ•° |
|------|--------|------|
| search_parsers.yaml æ›´æ–° | ä½ | 0.5h |
| parser_config.py æ›´æ–° | ä½ | 1h |
| browser_search_provider.py æ›´æ–° | ä¸­ | 2h |
| pagination_strategy.py æ–°è¦ä½œæˆ | ä¸­ | 2h |
| éåŒæœŸã‚­ãƒ¥ãƒ¼ã¨ã®çµ±åˆ | ä¸­ | 1.5h |
| ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒ»ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ | ä½ | 1h |
| ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆãƒ¢ãƒƒã‚¯æˆ¦ç•¥å«ã‚€ï¼‰ | ä¸­ | 2h |
| **åˆè¨ˆ** | | **10hï¼ˆç´„1.5æ—¥ï¼‰** |

**Note**: ADR-0014 Phase 1ï¼ˆTabPool: max_tabs=1ï¼‰ã¯åˆ¥å·¥æ•°ï¼ˆPhase 4ã§å®Ÿè£…ï¼‰ã€‚

---

## 6. ADRåˆ¤æ–­

### çµè«–: ADR-0014ã‚’å‰æã¨ã—ã¦æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§è©³ç´°è¨­è¨ˆ

**æ§‹é€ :**
- **ADR-0014**: Browser SERP Resource Controlï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ±ºå®šï¼‰
  - TabPoolï¼ˆPhase 1: max_tabs=1ï¼‰
  - max_tabs>1 ã®æ®µéšçš„è§£æ”¾ï¼ˆå°†æ¥ï¼‰
- **æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆR_ï¼‰**: SERP Enhancementï¼ˆæ©Ÿèƒ½è©³ç´°è¨­è¨ˆï¼‰
  - ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³URLæ§‹ç¯‰
  - åœæ­¢åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯
  - ã‚­ãƒ£ãƒƒã‚·ãƒ¥/ãƒãƒ¼ã‚¸æˆ¦ç•¥

---

## 7. æ³¨æ„äº‹é …

### 7.1 ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã¨ã®å…¼ã­åˆã„

ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ã§è¤‡æ•°ãƒšãƒ¼ã‚¸ã‚’å–å¾—ã™ã‚‹ã¨:
- QPSåˆ¶é™ã«ã²ã£ã‹ã‹ã‚Šã‚„ã™ã„
- æ—¥æ¬¡åˆ¶é™ã‚’æ—©ãæ¶ˆè²»ã™ã‚‹
- CAPTCHAãƒªã‚¹ã‚¯ãŒä¸Šæ˜‡

**å¯¾ç­–**: ãƒ©ã‚¹ãƒˆãƒã‚¤ãƒ«ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆGoogle/Bing/Braveï¼‰ã¯ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ã‚’æ¤œè¨ã€‚

### 7.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ•´åˆæ€§

```python
# ç¾åœ¨ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼
cache_key = f"{normalized_query}|{engines}|{time_range}"

# å¤‰æ›´å¾Œï¼ˆserp_max_pages ã‚’è¿½åŠ ï¼‰
cache_key = f"{normalized_query}|{engines}|{time_range}|serp_max_pages={max_pages}"
```

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼è¨­è¨ˆ:**
- `serp_max_pages` ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«å«ã‚ã‚‹ï¼ˆç•°ãªã‚‹ãƒšãƒ¼ã‚¸è¨­å®šã¯ç•°ãªã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¨ãƒ³ãƒˆãƒªï¼‰
- 1æ¤œç´¢=1ã‚¨ãƒ³ã‚¸ãƒ³é¸æŠã®ãŸã‚ã€çµæœã¯ãã®ã‚¨ãƒ³ã‚¸ãƒ³ã®å…¨ãƒšãƒ¼ã‚¸ã‚’ãƒãƒ¼ã‚¸ã—ãŸã‚‚ã®ãŒã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚Œã‚‹
- `pagination_type` / `results_per_page` ã¯**ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã«å«ã‚ãªã„**ï¼ˆè¨­å®šå¤‰æ›´æ™‚ã¯TTLçµŒé or æ‰‹å‹•ã‚¯ãƒªã‚¢ï¼‰

### 7.2.1 ãƒšãƒ¼ã‚¸ä¸Šé™ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®æ„å‘³ã®åˆ†é›¢ï¼ˆé‡è¦ï¼‰

æœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¯ã€Œãƒšãƒ¼ã‚¸ä¸Šé™ã€ãŒè¤‡æ•°ã®æ„å‘³ã§ç™»å ´ã™ã‚‹ãŸã‚ã€å®Ÿè£…æ™‚ã«æ··ç·šã—ã‚„ã™ã„ï¼š

- **ã‚¯ãƒ­ãƒ¼ãƒ«äºˆç®—ï¼ˆbudgetï¼‰**: ç ”ç©¶ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å´ã® `budget_pages`
- **SERPãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³**: `serp_page` / `serp_max_pages`ï¼ˆæœ¬æ©Ÿèƒ½ï¼‰

**æ–¹é‡**: **äº’æ›ãªã—**ã§SERPç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ `serp_page` / `serp_max_pages` ã«çµ±ä¸€ã—ã€æ—§ `SearchOptions.page` ã¯å‰Šé™¤ã™ã‚‹ã€‚

### 7.3 çµæœã®ãƒãƒ¼ã‚¸

åŒä¸€ã‚¨ãƒ³ã‚¸ãƒ³ã®è¤‡æ•°ãƒšãƒ¼ã‚¸çµæœã‚’ãƒãƒ¼ã‚¸ã™ã‚‹éš›:
- URLé‡è¤‡æ’é™¤ãŒå¿…è¦ï¼ˆãƒšãƒ¼ã‚¸é–“ã§åŒã˜URLãŒå‡ºç¾ã™ã‚‹å ´åˆã‚ã‚Šï¼‰
- rank ã¯å–å¾—é †ã§æ±ºå®šï¼ˆãƒšãƒ¼ã‚¸1ã®çµæœãŒå…ˆã€ãƒšãƒ¼ã‚¸2ãŒå¾Œï¼‰
- 1æ¤œç´¢=1ã‚¨ãƒ³ã‚¸ãƒ³ã®ãŸã‚ã€ã‚¨ãƒ³ã‚¸ãƒ³é–“æ··åˆã®è€ƒæ…®ã¯ä¸è¦

### 7.4 éåŒæœŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¨ã®çµ±åˆ

**ç¾çŠ¶**: `queue_searches` â†’ `search_action` â†’ `BrowserSearchProvider.search()` ã¯å˜ä¸€ãƒšãƒ¼ã‚¸å–å¾—ã‚’å‰æã€‚

**å¯¾å¿œæ–¹é‡**:
- 1ã‚¯ã‚¨ãƒª = 1ã‚¸ãƒ§ãƒ–ï¼ˆè¤‡æ•°ãƒšãƒ¼ã‚¸ã¯åŒä¸€ã‚¸ãƒ§ãƒ–å†…ã§é€æ¬¡å–å¾—ï¼‰
- `jobs.input_json` ã« `budget_pages` / `serp_page` / `serp_max_pages` ã‚’å«ã‚ã‚‹
- é€²æ—é€šçŸ¥ã¯æœ€åˆã®ãƒšãƒ¼ã‚¸å–å¾—å®Œäº†æ™‚ç‚¹ã§è¡Œã†
- `stop_task(mode=immediate)` æ™‚ã¯å–å¾—æ¸ˆã¿ãƒšãƒ¼ã‚¸ã®çµæœã‚’ä¿æŒ

### 7.5 ãƒªã‚½ãƒ¼ã‚¹åˆ¶å¾¡ï¼ˆADR-0014å‚ç…§ï¼‰

> **Note**: TabPoolï¼ˆmax_tabs=1ï¼‰ãŠã‚ˆã³æ®µéšçš„ãªä¸¦åˆ—åŒ–ã®è¨­è¨ˆã¯ [ADR-0014](adr/0014-browser-serp-resource-control.md) ã‚’å‚ç…§ã€‚
> æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ADR-0014ã®ãƒªã‚½ãƒ¼ã‚¹åˆ¶å¾¡ãŒå®Ÿè£…æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ã‚’å‰æã¨ã™ã‚‹ã€‚

### 7.6 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

| ã‚·ãƒŠãƒªã‚ª | å¯¾å¿œæ–¹é‡ |
|---------|---------|
| N+1ãƒšãƒ¼ã‚¸ç›®ã§CAPTCHA | 1ã€œNãƒšãƒ¼ã‚¸ã®çµæœã¯ä¿æŒã€ä»‹å…¥ã‚­ãƒ¥ãƒ¼ã¸è¿½åŠ  |
| N+1ãƒšãƒ¼ã‚¸ç›®ã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | éƒ¨åˆ†æˆåŠŸã¨ã—ã¦æ‰±ã†ï¼ˆã‚¨ãƒ©ãƒ¼ã¯ãƒ­ã‚°ã®ã¿ï¼‰ |
| ãƒšãƒ¼ã‚¸é–“ã§ã‚¨ãƒ³ã‚¸ãƒ³åˆ‡ã‚Šæ›¿ãˆ | ç¦æ­¢ï¼ˆåŒä¸€ã‚¨ãƒ³ã‚¸ãƒ³ã§ç¶™ç¶šï¼‰ |

### 7.7 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

1. **å³æ™‚ç„¡åŠ¹åŒ–**: `serp_max_pages: 1`ï¼ˆã¾ãŸã¯ `pagination_enabled: false`ï¼‰ã‚’è¨­å®š
2. **DBãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯**: `ALTER TABLE serp_items DROP COLUMN page_number;`
3. **éƒ¨åˆ†ç„¡åŠ¹åŒ–**: ã‚¨ãƒ³ã‚¸ãƒ³åˆ¥ã« `pagination_enabled: false` ã‚’è¨­å®š

---

## 8. å®Ÿè£…ã‚¿ã‚¹ã‚¯

### Phase 1: åŸºç›¤æ•´å‚™ âœ…
- [x] `config/search_parsers.yaml` ã«ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¿½åŠ ï¼ˆpagination_type, results_per_page, offset/page ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
- [x] `src/search/parser_config.py` ã§ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³è¨­å®šèª­ã¿è¾¼ã¿ï¼ˆ`PaginationConfig` dataclass, `EngineParserConfig.pagination`ï¼‰
- [x] `build_search_url()` ã«offset/pageå¼•æ•°è¿½åŠ ï¼ˆ`serp_page` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œï¼‰

### Phase 2: æ¤œç´¢ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å¯¾å¿œ âœ…
- [x] `browser_search_provider.py` ã§ `options.serp_page` ã‚’ä½¿ç”¨ï¼ˆãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—å®Ÿè£…æ¸ˆã¿: 931-1169è¡Œï¼‰
- [x] ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ã« `serp_max_pages` å«ã‚ã‚‹ï¼ˆ`search_api.py` ã® `_get_cache_key()` é–¢æ•°ï¼‰
- [ ] `SearchResponse` ã«ãƒšãƒ¼ã‚¸æƒ…å ±è¿½åŠ ï¼ˆä»»æ„ / æœªå®Ÿè£…ã ãŒå‹•ä½œã«å½±éŸ¿ãªã—ï¼‰

### Phase 3: åœæ­¢åˆ¤æ–­ãƒ­ã‚¸ãƒƒã‚¯ âœ…
- [x] `pagination_strategy.py` æ–°è¦ä½œæˆ
- [x] é£½å’Œæ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆ`calculate_novelty_rate()`ï¼‰
- [x] åç©«ç‡ãƒ™ãƒ¼ã‚¹åœæ­¢å®Ÿè£…ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ã¯å®Ÿè£…æ¸ˆã¿ï¼‰
- [x] è¨­å®šå¯èƒ½ãªã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼é¸æŠï¼ˆ`fixed`, `auto`, `exhaustive`ï¼‰

### Phase 4: çµ±åˆãƒ»ãƒ†ã‚¹ãƒˆ âœ…
- [x] å˜ä½“ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆ`test_pagination_strategy.py`: 17ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼‰
- [ ] çµåˆãƒ†ã‚¹ãƒˆï¼ˆå®Ÿã‚¨ãƒ³ã‚¸ãƒ³ï¼‰- æ‰‹å‹•æ¤œè¨¼ã®ã¿
- [x] Q_ASYNC / ADRæ›´æ–°ï¼ˆQ_ASYNC_ARCHITECTURE.md Phase 5 å®Œäº†ãƒãƒ¼ã‚¯æ¸ˆã¿ï¼‰

### Phase 5: DBæ‹¡å¼µ âš ï¸ ä¸€éƒ¨æœªå®Œäº†
- [x] `serp_items.page_number` ã‚«ãƒ©ãƒ è¿½åŠ ï¼ˆ`schema.sql` 64è¡Œç›®ã«è¿½åŠ æ¸ˆã¿ï¼‰
- [x] ã‚¹ã‚­ãƒ¼ãƒã‚’æ›´æ–°ã—ã€DBã‚’ä½œã‚Šç›´ã—
- [ ] **`page_number` ã®ä¿å­˜å‡¦ç†ãŒæœªå®Ÿè£…**ï¼ˆè©³ç´°ã¯ Â§8.1 å‚ç…§ï¼‰

---

### 8.1 æ®‹ã‚¿ã‚¹ã‚¯è©³ç´°

#### ğŸ”´ Issue 1: `page_number` ãŒDBã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„

**ç¾çŠ¶:**
- `schema.sql` ã« `serp_items.page_number` ã‚«ãƒ©ãƒ ã¯è¿½åŠ æ¸ˆã¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ `1`ï¼‰
- ã—ã‹ã— `search_api.py` ã® `search_serp()` é–¢æ•°ï¼ˆ812-826è¡Œï¼‰ã§ `serp_items` ã« INSERT ã™ã‚‹éš›ã€`page_number` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ãªã„

**å½±éŸ¿:**
- ç›£æŸ»/å†ç¾æ€§ã®æ‹…ä¿ãŒã§ããªã„ï¼ˆã©ã®SERPãƒšãƒ¼ã‚¸ã‹ã‚‰å–å¾—ã•ã‚ŒãŸã‹è¿½è·¡ä¸å¯ï¼‰
- ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã€Œå¿…é ˆã€ã¨ã—ã¦ã„ã‚‹æ©Ÿèƒ½ãŒæœªå®Ÿè£…

**ä¿®æ­£ç®‡æ‰€:**

```python
# src/search/search_api.py:812-826
# ç¾åœ¨:
await db.insert(
    "serp_items",
    {
        "query_id": query_id,
        "engine": result["engine"],
        "rank": result["rank"],
        "url": result["url"],
        "title": result["title"],
        "snippet": result["snippet"],
        "published_date": result.get("date"),
        "source_tag": result["source_tag"],
        "cause_id": trace.id,
        # "page_number" ãŒæ¬ è½
    },
)
```

**å¯¾å¿œæ–¹é‡:**
1. `SearchResult` / `BrowserSearchProvider` ã§ `page_number` ã‚’çµæœã«å«ã‚ã‚‹
2. `search_serp()` ã§ INSERT æ™‚ã« `page_number` ã‚’ä¿å­˜

**Doneå®šç¾©:** `serp_items` INSERTæ™‚ã« `page_number` ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹ + ãƒ†ã‚¹ãƒˆã§æ¤œè¨¼æ¸ˆã¿

#### ğŸŸ¡ Issue 2: `harvest_rate` ãŒè¨ˆç®—ã•ã‚Œã¦ã„ãªã„

**ç¾çŠ¶:**
- `browser_search_provider.py` ã® 1155è¡Œç›®ã§ `harvest_rate=None` ã®ã¾ã¾ `PaginationContext` ã«æ¸¡ã—ã¦ã„ã‚‹
- `pagination_strategy.py` ã®ãƒ­ã‚¸ãƒƒã‚¯ã¯å®Ÿè£…æ¸ˆã¿ã ãŒã€å®Ÿéš›ã®å€¤ãŒæ¸¡ã•ã‚Œã¦ã„ãªã„

**å½±éŸ¿:**
- åç©«ç‡ãƒ™ãƒ¼ã‚¹ã®åœæ­¢åˆ¤æ–­ãŒæ©Ÿèƒ½ã—ãªã„ï¼ˆ`novelty_rate` ã®ã¿ã§åˆ¤æ–­ï¼‰
- å®Ÿç”¨ä¸Šã¯ `novelty_rate` ã§ååˆ†ãªå ´åˆãŒå¤šã„ãŸã‚ã€å„ªå…ˆåº¦ã¯ä½ã„

**å¯¾å¿œæ–¹é‡:**
- `harvest_rate` ã®è¨ˆç®—ã¯ç ”ç©¶ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆ`ExplorationState`ï¼‰ã¨ã®é€£æºãŒå¿…è¦
- ä¸­æœŸçš„ãªæ”¹å–„ã‚¿ã‚¹ã‚¯ã¨ã—ã¦æ‰±ã†ï¼ˆç¾çŠ¶ã®å‹•ä½œã«å¤§ããªå•é¡Œãªã—ï¼‰

**Doneå®šç¾©:** `harvest_rate` ãŒè¨ˆç®—ã•ã‚Œã¦ `PaginationContext` ã«æ¸¡ã•ã‚Œã€åœæ­¢åˆ¤æ–­ã«ä½¿ç”¨ã•ã‚Œã‚‹

---

## 9. å‚è€ƒè³‡æ–™

- `src/search/browser_search_provider.py` - æ¤œç´¢ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼å®Ÿè£…
- `src/search/provider.py` - SearchOptions, SearchResponseå®šç¾©
- `src/search/search_parsers.py` - å„ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ‘ãƒ¼ã‚µãƒ¼
- `config/search_parsers.yaml` - ãƒ‘ãƒ¼ã‚µãƒ¼è¨­å®š
- `docs/adr/0010-async-search-queue.md` - éåŒæœŸæ¤œç´¢ã‚­ãƒ¥ãƒ¼ADRï¼ˆPhase 5ã§æœ¬æ©Ÿèƒ½å®Ÿè£…ï¼‰
- `docs/adr/0014-browser-serp-resource-control.md` - ãƒ–ãƒ©ã‚¦ã‚¶SERPãƒªã‚½ãƒ¼ã‚¹åˆ¶å¾¡ADR
- `docs/archive/Q_ASYNC_ARCHITECTURE.md` - éåŒæœŸã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„ï¼ˆPhase 5ã§SERP Enhancementå®Ÿè£…: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¸ˆã¿ï¼‰
- `src/storage/schema.sql` - DBã‚¹ã‚­ãƒ¼ãƒ

